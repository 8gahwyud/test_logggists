<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Платформа для логистов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
        integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        /* Основные стили */
        * {
            font-family: "Roboto", sans-serif;
            font-optical-sizing: auto;
            font-style: normal;
            font-variation-settings: "wdth" 100;
            box-sizing: border-box;
        }

        body {
            background: rgba(243, 244, 246, 1);
            margin: 0;
            padding: 0;
        }

        /* Стили для навигации между страницами */
        .page {
            display: none;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .page.active {
            display: block;
        }

        /* Скрываем навигацию по умолчанию */
        .bottom-nav {
            display: none;
        }

        /* Показываем навигацию только на активной странице */
        .page.active .bottom-nav {
            display: flex;
        }

        /* Header */
        header {
            width: 100%;
            height: 110px;
            border: 1px solid rgba(217, 217, 217, 1);
            border-radius: 0px 0px 20px 20px;
            background: rgba(23, 117, 241, 1);
        }

        .header__logist {
            background: #059669;
        }

        .logist-profile {
            background: #059669;
        }

        /* Новый дизайн header */
        .new-design-header {
            width: auto;
            height: 70px;
            background: #1775F1;
            border-radius: 10px;
            display: flex;
            color: white;
            align-items: center;
            position: relative;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 25%);
            margin: 20px;
        }

        .new-design-header.logist-header {
            background: #059669;
        }

        .new-design-header-avatar {
            width: 52px;
            height: 52px;
            margin: 9px 15px 9px 10px;
            border-radius: 50%;
            object-fit: cover;
        }

        .new-design-header-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .new-design-header-info-fio {
            font-weight: 500;
            font-size: 16px;
            font-family: "Montserrat", sans-serif;
        }

        .new-design-header-info-status {
            font-size: 12px;
            opacity: 60%;
            font-family: "Montserrat", sans-serif;
        }

        .new-design-header-bell {
            position: absolute;
            right: 15px;
            cursor: pointer;
        }

        /* Инфо блоки */
        .info-blocks {
            display: flex;
            gap: 9px;
            margin: 8px 20px;
            justify-content: center;
        }

        .info-block {
            width: 110px;
            height: 70px;
            background: #FFFFFF;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            text-align: center;
            justify-content: center;
            align-items: center;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 25%);
        }

        .info-block-maininfo {
            font-size: 16px;
            font-weight: 600;
            font-family: "Montserrat", sans-serif;
            text-align: center;
            margin: 0;
        }

        .info-block-dopinfo {
            font-size: 12px;
            color: #3C3C43;
            opacity: 60%;
            font-family: "Montserrat", sans-serif;
            text-align: center;
            margin: 2px 0 0 0;
        }

        /* Новый поиск */
        .input-search-block {
            display: flex;
            gap: 15px;
            margin: 8px 20px 0px 20px;
            justify-content: center;
        }

        .new-input-search {
            width: 263px;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 10px;
            border: none;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 25%);
            font-family: "Montserrat", sans-serif;
        }

        .new-input-filtr {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 25%);
            cursor: pointer;
        }

        .header__container {
            margin-top: 33px;
            margin-left: 41px;
        }

        .header__title {
            margin: 0;
            color: rgba(255, 255, 255, 1);
            font-size: 20px;
            font-weight: 600;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .header__subtitle {
            margin-top: 10px;
            color: rgba(210, 210, 210, 1);
            font-size: 14px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        /* Search */
        .main__search {
            display: block;
            margin: 16px auto 0;
            width: 339px;
            height: 38px;
            border-radius: 10px;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
            background: rgba(255, 255, 255, 1);
            border: none;
            padding-left: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
            background-size: 20px 20px;
            font-size: 14px;
        }

        /* Vacancies */
        .vacancies {
            margin: 16px 0;
        }

        .vacancies__item {
            margin: 14px auto;
            padding: 21px;
            width: 318px;
            border-radius: 15px;
            box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
            background: rgba(255, 255, 255, 1);
        }

        .vacancies__item:last-child {
            margin-bottom: 75px;
        }

        .vacancies__title {
            display: block;
            color: rgba(0, 0, 0, 1);
            font-size: 16px;
            font-weight: 600;
            line-height: 100%;
            text-align: left;
        }

        .vacancies__description {
            display: block;
            margin-top: 14px;
            color: rgba(129, 129, 129, 1);
            font-size: 14px;
            font-weight: 400;
            line-height: 100%;
            text-align: left;
        }

        .vacancies__info {
            margin-top: 14px;
        }

        .vacancies__info-item {
            margin-top: 5px;
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }

        .vacancies__info-icon {
            width: 23px;
            height: 23px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vacancies__info-text {
            margin-top: 3px;
            color: rgba(129, 129, 129, 1);
            font-size: 14px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies__container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .vacancies__container-customer {
            display: flex;
            flex-direction: column;
        }

        .vacancies__time {
            display: block;
            color: rgba(129, 129, 129, 1);
            font-size: 12px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
            margin-top: 4px;
        }

        .vacancies__customer {
            width: 121px;
            display: block;
            color: #059669;
            font-size: 14px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies__container-order {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
        }

        .vacancies__price {
            display: block;
            color: rgba(5, 150, 105, 1);
            font-size: 16px;
            font-weight: 500;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies__button {
            margin-top: 11px;
            color: rgba(51, 132, 172, 1);
            font-size: 16px;
            font-weight: 500;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: center;
            width: 152px;
            height: 33px;
            border-radius: 10px;
            background: rgba(224, 242, 252, 1);
            border: none;
            cursor: pointer;
        }

        .vacancies__button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        /* Combined time and people */
        .vacancies__time-people {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Modals */
        /* Анимации для модальных окон */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .vacancies-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }
        
        /* Класс для открытого модального окна */
        .vacancies-modal.modal-open {
            display: flex !important;
        }
        
        /* Модалка чата должна быть выше других модалок */
        #orderChatModal {
            z-index: 10001 !important;
        }
        
        /* Для модального окна регистрации - центрируем контент */
        #registrationModal {
            align-items: center !important;
            justify-content: center !important;
        }
        
        #registrationModal .vacancies-modal__content {
            max-width: 500px !important;
            width: 90% !important;
            margin: auto !important;
            border-radius: 12px !important;
            max-height: 90vh !important;
            align-self: center !important;
        }
        
        /* Анимация для модального окна регистрации (по центру) */
        #registrationModal.modal-open .vacancies-modal__content {
            animation: scaleIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .vacancies-modal__overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .vacancies-modal.modal-open .vacancies-modal__overlay {
            animation: fadeIn 0.15s ease-out;
        }

        .vacancies-modal__content {
            position: relative;
            background: #fff;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            z-index: 1;
            width: 100%;
            max-height: 100vh;
            overflow-y: auto;
        }
        
        /* Анимация всплытия снизу для обычных модальных окон */
        .vacancies-modal.modal-open .vacancies-modal__content {
            animation: slideUp 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .vacancies-modal__header {
            border-bottom: 0.8px solid rgba(217, 217, 217, 1);
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vacancies-modal__tittle {
            color: rgba(0, 0, 0, 1);
            font-size: 16px;
            font-weight: 600;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies-modal__close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .vacancies-modal__info {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .vacancies-modal__name {
            color: rgba(0, 0, 0, 1);
            font-size: 16px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies-modal__id {
            color: rgba(129, 129, 129, 0.46);
            font-size: 16px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies-modal__descr {
            display: block;
            margin-top: 19px;
            color: rgba(129, 129, 129, 1);
            font-size: 16px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .vacancies-modal__button {
            margin-top: 19px;
            width: 100%;
            height: 51px;
            border-radius: 12px;
            background: rgba(224, 242, 252, 1);
            border: none;
            color: rgba(51, 132, 172, 1);
            font-size: 20px;
            font-weight: 500;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: center;
            cursor: pointer;
        }

        .vacancies-modal__button.cancel {
            background: #FFE5E5;
            color: #D32F2F;
        }
        .vacancies-modal__button.accept {
            background: #afecb2;
            color: #5aa551;
        }

        /* Profile Screen */
        .header__container-twoScreen {
            margin-top: 23px;
            margin-left: 30px;
            display: flex;
            justify-content: left;
            align-items: center;
        }

        .header__photo {
            width: 66px;
            height: 63px;
        }

        .header__photo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .header__info {
            display: flex;
            flex-direction: column;
            margin-left: 12px;
        }

        .header__name {
            color: rgba(255, 255, 255, 1);
            font-size: 16px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .header__status {
            margin-top: 6px;
            color: rgba(255, 255, 255, 1);
            font-size: 14px;
            font-weight: 500;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .main-twoScreen {
            padding: 0 21px;
        }

        .stats {
            margin: 0 auto;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .stats__item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 113px;
            height: 71px;
            border-radius: 10px;
            box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
            background: rgba(255, 255, 255, 1);
        }

        .stats__value {
            color: rgba(0, 0, 0, 1);
            font-size: 16px;
            font-weight: 400;
            line-height: 100%;
        }

        .stats__label {
            margin-top: 2px;
            color: rgba(129, 129, 129, 1);
            font-size: 14px;
            font-weight: 400;
            line-height: 100%;
        }

        .screen-two__title {
            margin-top: 17px;
            display: flex;
            justify-content: left;
            align-items: center;
        }

        .screen-two__title-icon {
            width: 23px;
            height: 23px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screen-two__title-text {
            margin: 0;
            margin-left: 8px;
            color: rgba(0, 0, 0, 1);
            font-size: 16px;
            font-weight: 500;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .actions {
            padding: 19px 22px;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
            background: rgba(255, 255, 255, 1);
        }

        .actions__button {
            padding-bottom: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 1);
            width: 100%;
            height: 100%;
            border: none;
            border-bottom: 0.8px solid rgba(217, 217, 217, 1);
            cursor: pointer;
        }

        .actions__button:not(:first-child) {
            margin-top: 23px;
        }

        .actions__button:last-child {
            border: none;
            padding-bottom: 0px;
        }

        .actions__left-group {
            display: flex;
            justify-content: left;
            align-items: flex-end;
            gap: 11px;
        }

        .actions__icon {
            display: block;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .actions__text {
            display: block;
            color: rgba(0, 0, 0, 1);
            font-size: 14px;
            font-weight: 400;
            line-height: 100%;
            letter-spacing: 0%;
            text-align: left;
        }

        .actions__arrow {
            display: block;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Create Order Form */
        .create-order {
            padding: 20px;
        }

        .create-order__title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-create {
            width: 100%;
            background-color: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 16px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Employee Cards */
        .employee-card {
            margin-top: 20px;
        }

        .employee-card__header {
            margin-bottom: 15px;
        }

        .employee-card__status-block {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .employee-card__status-text {
            font-weight: 600;
        }

        .employee-card__count {
            color: #666;
        }

        .employee-card__avatar-block {
            background-color: #F3F4F6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 9px;
            margin-bottom: 10px;
        }

        .employee-card__avatar {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .employee-card__name {
            flex: 1;
            margin: 0;
            font-weight: 500;
        }

        .employee-card__info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .employee-card__status {
            padding: 2px 8px;
            background-color: #A1FFE2;
            border-radius: 4px;
            color: #28A47E;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .employee-card__status-narasmotrenii {
            padding: 2px 8px;
            background-color: #FFE5A9;
            border-radius: 4px;
            color: #BA8F28;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .employee-card__orders-count {
            padding: 2px 8px;
            background-color: #9FD2FF;
            border-radius: 4px;
            color: #2F86D2;
            font-size: 12px;
        }

        .employee-card__rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }


        .employee-card-noninvite {
            background-color: #F3F4F6;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .employee-card__button {
            width: 100%;
            height: 28px;
            border: none;
            background-color: #059669;
            color: white;
            border-radius: 7px;
            cursor: pointer;
            margin-top: 8px;
        }

        .employee-card__stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .employee-card__work-status {
            font-weight: 500;
        }

        .employee-card__orders-label {
            color: #666;
        }

        .line {
            border-bottom: 1px solid #D9D9D9;
            margin: 19px 0px 0px 0px;
        }

        /* Filter Tabs */
        .filter-tabs {
            width: auto;
            height: 40px;
            gap: 8px;
            display: flex;
            margin-top: 8px;
            margin-bottom: 15px;
            justify-content: center;
            align-items: center;
        }

        .filter-tab {
            width: 171px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 25%);
            border: none;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            color: #333;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            width: 171px;
            height: 40px;
            background: #059669;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 25%);
            color: white;
        }

        /* Timer */
        .timer {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #D32F2F;
            font-weight: 500;
            margin-top: 5px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            height: 70px;
            box-sizing: border-box;
            border-top: 1px solid rgba(217, 217, 217, 1);
            background: rgba(255, 255, 255, 1);
            z-index: 1000;
            padding: 10px 0;
        }

        .bottom-nav__icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            width: 60px;
            height: 50px;
        }

        .bottom-nav__icon img {
            width: 24px;
            height: 24px;
        }

        .bottom-nav__label {
            font-size: 12px;
            margin-top: 4px;
            color: #666;
        }

        .bottom-nav__icon.active .bottom-nav__label {
            color: #1775F1;
            font-weight: 500;
        }

        /* Profile Modals */
        .balance-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .balance-card--on-hold {
            background: #FFEDC6;
            border: 0.8px solid #FEBC2F;
        }

        .balance-card--available {
            background: #E0F3FF;
            border: 0.8px solid #90D9FF;
        }

        .balance-card__label--on-hold {
            font-size: 16px;
            color: rgba(153, 105, 3, 0.7);
            margin: 0;
        }

        .balance-card__amount--on-hold {
            font-size: 32px;
            color: #7D5B12;
            margin: 9px 0px;
            font-weight: 700;
        }

        .balance-card__total--on-hold {
            font-size: 11px;
            color: rgba(153, 105, 3, 0.7);
            margin: 0px;
        }

        .balance-card__label--available {
            font-size: 16px;
            color: rgba(2, 94, 146, 0.749);
            margin: 0;
        }

        .balance-card__amount--available {
            font-size: 32px;
            color: #0C4A6E;
            margin: 9px 0px;
            font-weight: 700;
        }

        .balance-card__total--available {
            font-size: 11px;
            color: rgba(2, 94, 146, 0.749);
            margin: 0px;
        }

        .withdraw-btn {
            width: 100%;
            height: 55px;
            background-color: #059669;
            color: #FFFFFF;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .withdraw-methods__title {
            font-size: 14px;
            font-weight: 600;
            margin: 19px 0px 10px 0px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin: 10px 0;
        }

        .payment-method__icon {
            width: 24px;
            height: 24px;
            margin-right: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-method__name {
            flex: 1;
        }

        .payment-method__fee {
            color: #818181;
        }

        .payment-line {
            border: 0.8px solid #D9D9D9;
            margin: 10px 0;
        }

        .operation-item,
        .order-card {
            display: flex;
            align-items: center;
            margin: 19px 0px;
        }

        .operation-item__icon,
        .order-card__icon {
            width: 31px;
            height: 31px;
            margin-right: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .operation-item__info,
        .order-card__info {
            flex: 1;
        }

        .operation-item__title,
        .order-card__title {
            margin: 0px 0px 3px 0px;
            font-size: 13px;
        }

        .operation-item__date,
        .order-card__date {
            margin: 0;
            font-size: 11px;
            color: #818181;
        }

        .operation-item__amount {
            font-size: 14px;
            font-weight: 700;
        }

        .operation-item__amount--expense {
            color: #FF5F57;
        }

        .operation-item__amount--income {
            color: #059669;
        }

        .order-card__status {
            font-size: 14px;
            font-weight: 700;
        }

        .order-card__status--cancelled {
            color: #FF5F57;
        }

        .order-card__status--completed {
            color: #059669;
        }

        .support-topics__intro {
            font-size: 13px;
            color: #5A5A5A;
            margin: 19px 0px 19px 0px;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .topic-card {
            border-radius: 10px;
            background-color: #F3F4F6;
            padding: 15px;
        }

        .topic-card__title {
            font-size: 14px;
            font-weight: 400;
            margin: 0px 0px 7px 0px;
        }

        .topic-card__description {
            font-size: 12px;
            color: #5A5A5A;
            margin: 0;
        }

        .support-btn {
            width: 100%;
            height: 57px;
            background-color: #E0F2FC;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #3384AC;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            margin: 0 auto;
            cursor: pointer;
        }

        .support-btn__icon {
            width: 19px;
            height: 19px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Rating Stars */
        .rating {
            display: flex;
            align-items: center;
            gap: 2px;
        }


        /* Notification */
        .notification {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 14px;
            color: #856404;
        }

        /* Empty state styles */
        .no-orders {
            text-align: center;
            padding: 40px 20px;
        }

        .no-orders p {
            margin: 0;
        }

        .no-orders p:first-child {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        /* Стили для модалки подписок */
        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
        }

        .bottom-sheet {
            background: #ffffff;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-height: 85vh;
            overflow-y: auto;
        }

        .bottom-sheet__handle {
            width: 40px;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin: 16px auto;
        }

        .subscription-header {
            text-align: center;
            padding: 0 24px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .subscription-title {
            margin: 0 0 8px 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .subscription-subtitle {
            margin: 0;
            font-size: 1rem;
            color: #666;
        }

        .subscriptions-container {
            padding: 0 24px 24px;
        }

        .subscriptions-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }


        .subscription-footer {
            text-align: center;
            padding: 16px 24px 24px;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
            border-radius: 0 0 24px 24px;
        }

        .footer-text {
            margin: 0 0 12px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .confirm-button {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .bottom-sheet--active {
            transform: translateY(0);
        }

        @media (max-width: 480px) {
            .bottom-sheet {
                border-radius: 24px 24px 0 0;
            }
        }
    </style>
    <!-- Supabase Client для real-time -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
        
        const SUPABASE_URL = "https://zaaiwvnohyupxajurnrn.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphYWl3dm5vaHl1cHhhanVybnJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MDgwNTUsImV4cCI6MjA3MzA4NDA1NX0.IaQjZ-oxkFzIhiTsACXOEZxL5kAzXh-CdmsDBZth8bI";
        window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("[Supabase] Клиент инициализирован");
    </script>
</head>

<body>
    <!-- Страница 1: Мои заказы -->
    <div id="page-orders" class="page active">
        <header class="new-design-header logist-header">
            <img class="new-design-header-avatar" src="img/new-desin/avatar.png" alt="" id="logistAvatar">
            <div class="new-design-header-info">
                <p class="new-design-header-info-fio" id="logistName">Иванова И.И.</p>
                <p class="new-design-header-info-status" id="logistStatus">Новый пользователь</p>
            </div>
            <img class="new-design-header-bell" src="img/new-desin/bell.png" alt="" id="logistNotificationsBell">
        </header>
        <main>
            <!-- Инфо блоки -->
            <div class="info-blocks">
                <div class="info-block">
                    <p class="info-block-maininfo" id="logistActiveOrders">0</p>
                    <p class="info-block-dopinfo">Активных заказов</p>
                </div>
                <div class="info-block">
                    <p class="info-block-maininfo" id="logistInWork">0</p>
                    <p class="info-block-dopinfo">В работе</p>
                </div>
                <div class="info-block">
                    <p class="info-block-maininfo" id="logistResponses">0</p>
                    <p class="info-block-dopinfo">Откликов</p>
                </div>
            </div>
            <!-- Поиск и фильтр -->
            <div class="input-search-block">
                <input class="new-input-search" type="text" placeholder="Поиск" id="logistSearchInput">
                <div class="new-input-filtr" id="logistFilterBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6H20M7 12H17M9 18H15" stroke="#666" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </div>
            </div>
            <div class="filter-tabs" style="margin-bottom: 15px;">
                <button class="filter-tab active" data-order-filter="active" id="tabActiveOrders">Активные</button>
                <button class="filter-tab" data-order-filter="finished" id="tabFinishedOrders">Завершенные</button>
            </div>
            <div class="vacancies" id="orders-container">
                <!-- Заказы будут рендериться через JavaScript -->
            </div>
        </main>
        <nav class="bottom-nav">
            <button class="bottom-nav__icon active" onclick="showPage('page-orders')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M8 7V3M16 7V3M7 11H17M5 21H19C20.1046 21 21 20.1046 21 19V7C21 5.89543 20.1046 5 19 5H5C3.89543 5 3 5.89543 3 7V19C3 20.1046 3.89543 21 5 21Z"
                        stroke="#1775F1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Заказы</span>
            </button>
            <button class="bottom-nav__icon" onclick="showPage('page-create-order')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="12" r="10" stroke="#666" stroke-width="2" />
                </svg>
                <span class="bottom-nav__label">Создать</span>
            </button>
            <button class="bottom-nav__icon" onclick="showPage('page-profile')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path
                        d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Профиль</span>
            </button>
            <button class="bottom-nav__icon" id="bottomNavFinance">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 1V23M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Финансы</span>
            </button>
            <button class="bottom-nav__icon" id="bottomNavSupport">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M18.364 5.63604C21.8787 9.15076 21.8787 14.8492 18.364 18.364C14.8492 21.8787 9.15076 21.8787 5.63604 18.364C2.12132 14.8492 2.12132 9.15076 5.63604 5.63604C9.15076 2.12132 14.8492 2.12132 18.364 5.63604"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 16V12M12 8H12.01" stroke="#666" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Поддержка</span>
            </button>
        </nav>
    </div>

    <!-- Страница 2: Профиль -->
    <div id="page-profile" class="page">
        <header class="new-design-header logist-header">
            <img class="new-design-header-avatar" src="img/new-desin/avatar.png" alt="" id="logistProfileAvatar">
            <div class="new-design-header-info">
                <p class="new-design-header-info-fio" id="logistProfileName">Иванова И.И.</p>
                <p class="new-design-header-info-status" id="logistProfileStatus">Новый пользователь</p>
            </div>
            <img class="new-design-header-bell" src="img/new-desin/bell.png" alt="" id="logistProfileNotificationsBell">
        </header>
        <main style="padding: 20px; background: #F5F5F5; min-height: calc(100vh - 82px);">
            <!-- Карточка "Оформить подписку" -->
            <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="showSubscriptionSheet()">
                <div style="width: 40px; height: 40px; background: #FEE2E2; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 3V21H21" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 16L12 11L16 15L21 10" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <p style="margin: 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Оформить подписку</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Она нужна для различных улучшений</p>
                </div>
            </div>
            
            <!-- 6 информационных блоков (сетка 2x3) -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p id="logistProfileBalance" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">41 000 p</p>
                    <p style="margin: 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Баланс</p>
                </div>
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p id="logistProfileActiveOrders" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">3</p>
                    <p style="margin: 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Активных заказов</p>
                </div>
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p id="logistProfileAvailableOrders" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">2</p>
                    <p style="margin: 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Доступно заказов</p>
                </div>
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p id="logistProfileTotalOrders" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">432</p>
                    <p style="margin: 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Всего заказов</p>
                </div>
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p id="logistProfileSuccessfulOrders" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">3</p>
                    <p style="margin: 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Успешных заказов</p>
                </div>
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p id="logistProfileCancelledOrders" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">2</p>
                    <p style="margin: 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">Отмененные</p>
                </div>
            </div>
            
            <!-- Карточки достижений (2x2) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <!-- Мастер заказов -->
                <div style="background: #1775F1; border-radius: 12px; padding: 16px; text-align: center;">
                    <p style="margin: 0; font-size: 18px; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">Мастер заказов</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: rgba(255,255,255,0.8); font-family: 'Montserrat', sans-serif;">6 уровень</p>
                </div>
                
                <!-- Завершенные -->
                <div style="background: #FF6B6B; border-radius: 12px; padding: 16px; text-align: center;">
                    <p style="margin: 0; font-size: 18px; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">Завершенные</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: rgba(255,255,255,0.8); font-family: 'Montserrat', sans-serif;">1000+ завершенных</p>
                </div>
                
                <!-- Проверенный -->
                <div style="background: #059669; border-radius: 12px; padding: 16px; text-align: center;">
                    <p style="margin: 0; font-size: 18px; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">Проверенный</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: rgba(255,255,255,0.8); font-family: 'Montserrat', sans-serif;">Прошел проверку</p>
                </div>
                
                <!-- Отменненные -->
                <div style="background: white; border-radius: 12px; padding: 16px; text-align: center;">
                    <p style="margin: 0; font-size: 18px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">Отменненные</p>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #666; font-family: 'Montserrat', sans-serif;">12</p>
                </div>
            </div>
        </main>
        <nav class="bottom-nav">
            <button class="bottom-nav__icon" onclick="showPage('page-orders')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M8 7V3M16 7V3M7 11H17M5 21H19C20.1046 21 21 20.1046 21 19V7C21 5.89543 20.1046 5 19 5H5C3.89543 5 3 5.89543 3 7V19C3 20.1046 3.89543 21 5 21Z"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Заказы</span>
            </button>
            <button class="bottom-nav__icon" onclick="showPage('page-create-order')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="12" r="10" stroke="#666" stroke-width="2" />
                </svg>
                <span class="bottom-nav__label">Создать</span>
            </button>
            <button class="bottom-nav__icon active" onclick="showPage('page-profile')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                        stroke="#1775F1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path
                        d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z"
                        stroke="#1775F1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Профиль</span>
            </button>
            <button class="bottom-nav__icon" id="bottomNavFinanceProfile">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 1V23M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Финансы</span>
            </button>
            <button class="bottom-nav__icon" id="bottomNavSupportProfile">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M18.364 5.63604C21.8787 9.15076 21.8787 14.8492 18.364 18.364C14.8492 21.8787 9.15076 21.8787 5.63604 18.364C2.12132 14.8492 2.12132 9.15076 5.63604 5.63604C9.15076 2.12132 14.8492 2.12132 18.364 5.63604"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 16V12M12 8H12.01" stroke="#666" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Поддержка</span>
            </button>
        </nav>
    </div>

    <!-- Страница 3: Создание заказа -->
    <div id="page-create-order" class="page">
        <header class="new-design-header logist-header">
            <img class="new-design-header-avatar" src="img/new-desin/avatar.png" alt="" id="logistCreateOrderAvatar">
            <div class="new-design-header-info">
                <p class="new-design-header-info-fio" id="logistCreateOrderName">Иванова И.И.</p>
                <p class="new-design-header-info-status" id="logistCreateOrderStatus">Новый пользователь</p>
            </div>
            <img class="new-design-header-bell" src="img/new-desin/bell.png" alt="" id="logistCreateOrderNotificationsBell">
        </header>

        <main class="create-order" style="padding: 20px; background: #F5F5F5; min-height: calc(100vh - 82px);">
            <h1 class="create-order__title" style="font-size: 24px; font-weight: 600; margin-bottom: 20px; text-align: center; font-family: 'Montserrat', sans-serif; color: #333;">Создание заказа</h1>

            <form id="orderForm" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="title" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Название</label>
                    <input type="text" class="form-input" id="title" placeholder="Введите название заказа" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="description" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Описание</label>
                    <textarea class="form-textarea" id="description" placeholder="Опишите детали заказа" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif; min-height: 100px; resize: vertical;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="location" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Место</label>
                    <input type="text" class="form-input" id="location" placeholder="Укажите место выполнения" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="metro_station" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Станция метро</label>
                    <input type="text" class="form-input" id="metro_station" placeholder="Укажите станцию метро" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                </div>

                <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="date" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Дата начала</label>
                        <input type="date" class="form-input" id="date" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="start_time" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Время начала</label>
                        <input type="time" class="form-input" id="start_time" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                    </div>
                </div>

                <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="people" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Кол-во людей</label>
                        <input type="number" class="form-input" id="people" min="1" placeholder="0" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                    </div>

                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="duration" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Время (часы)</label>
                        <input type="number" class="form-input" id="duration" min="4" placeholder="4" value="4" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="rate" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Стоимость часа</label>
                    <input type="number" class="form-input" id="rate" min="1" placeholder="0" required style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                        <input type="checkbox" id="premium" style="width: 20px; height: 20px; cursor: pointer;"> 
                        <span style="font-size: 14px; color: #333;">Премиум заказ (только для платных подписок)</span>
                    </label>
                </div>

                <div class="form-group" id="requirementsGroup" style="display: none; margin-bottom: 20px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Требования</label>
                    <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 12px;">
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                            <input type="checkbox" id="onlyWomen" style="width: 20px; height: 20px; cursor: pointer;"> 
                            <span style="font-size: 14px; color: #333;">Только женщины</span>
                        </label>
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                            <input type="checkbox" id="onlyMen" style="width: 20px; height: 20px; cursor: pointer;"> 
                            <span style="font-size: 14px; color: #333;">Только мужчины</span>
                        </label>
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                            <input type="checkbox" id="minRating" style="width: 20px; height: 20px; cursor: pointer;"> 
                            <span style="font-size: 14px; color: #333;">Рейтинг не ниже 4</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="additionalRequirementsGroup" style="display: none; margin-bottom: 20px;">
                    <label class="form-label" for="requirements" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333; font-family: 'Montserrat', sans-serif;">Дополнительные требования</label>
                    <textarea class="form-textarea" id="requirements" placeholder="Укажите особые требования" style="width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 10px; font-size: 14px; font-family: 'Montserrat', sans-serif; min-height: 100px; resize: vertical;"></textarea>
                </div>

                <button type="submit" class="btn-create" style="width: 100%; padding: 16px; background: #059669; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif; margin-top: 20px;">Создать заказ</button>
            </form>
        </main>

        <nav class="bottom-nav">
            <button class="bottom-nav__icon" onclick="showPage('page-orders')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M8 7V3M16 7V3M7 11H17M5 21H19C20.1046 21 21 20.1046 21 19V7C21 5.89543 20.1046 5 19 5H5C3.89543 5 3 5.89543 3 7V19C3 20.1046 3.89543 21 5 21Z"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Заказы</span>
            </button>
            <button class="bottom-nav__icon active" onclick="showPage('page-create-order')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="#1775F1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="12" r="10" stroke="#1775F1" stroke-width="2" />
                </svg>
                <span class="bottom-nav__label">Создать</span>
            </button>
            <button class="bottom-nav__icon" onclick="showPage('page-profile')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path
                        d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Профиль</span>
            </button>
            <button class="bottom-nav__icon" id="bottomNavFinanceCreate">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 1V23M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Финансы</span>
            </button>
            <button class="bottom-nav__icon" id="bottomNavSupportCreate">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M18.364 5.63604C21.8787 9.15076 21.8787 14.8492 18.364 18.364C14.8492 21.8787 9.15076 21.8787 5.63604 18.364C2.12132 14.8492 2.12132 9.15076 5.63604 5.63604C9.15076 2.12132 14.8492 2.12132 18.364 5.63604"
                        stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 16V12M12 8H12.01" stroke="#666" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav__label">Поддержка</span>
            </button>
        </nav>
    </div>

    <!-- Модальное окно откликов -->
    <div class="vacancies-modal" id="responsesModal">
        <div class="vacancies-modal__overlay" data-close="true"></div>
        <div class="vacancies-modal__content">
            <div class="modal-content-wrapper">
                <!-- Ручка для свайпа -->
                <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px; margin: 12px auto 0;"></div>
                
                <!-- Header -->
                <div style="position: relative; margin-top: 16px; margin-bottom: 20px;">
                    <div class="vacancies-modal__close" data-close="true" style="position: absolute; top: 0; right: 0; font-size: 24px; cursor: pointer; color: #666;">&times;</div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600; text-align: center; color: #333; font-family: 'Montserrat', sans-serif;">Панель управления заказом</h2>
                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666; text-align: center; font-family: 'Montserrat', sans-serif;">Управляйте исполнителями и чатом</p>
                </div>
                
                <!-- Вкладки -->
                <div id="orderTabs" style="display: flex; background: #f5f5f5; border-radius: 12px; padding: 4px; margin-bottom: 20px;">
                    <button class="order-tab active" data-tab="pending" onclick="switchOrderTab('pending')" style="flex: 1; padding: 12px 16px; text-align: center; border-radius: 8px; cursor: pointer; border: none; background: white; color: #333; font-weight: 600; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                        Отклики
                    </button>
                    <button class="order-tab" data-tab="accepted" onclick="switchOrderTab('accepted')" style="flex: 1; padding: 12px 16px; text-align: center; border-radius: 8px; cursor: pointer; border: none; background: transparent; color: #666; font-weight: 600; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                        Подтверждают
                    </button>
                    <button class="order-tab" data-tab="working" onclick="switchOrderTab('working')" style="flex: 1; padding: 12px 16px; text-align: center; border-radius: 8px; cursor: pointer; border: none; background: transparent; color: #666; font-weight: 600; font-size: 14px; font-family: 'Montserrat', sans-serif;">
                        В работе
                    </button>
                </div>

                <!-- Список исполнителей -->
                <div id="employeesContainer" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                    <!-- Список исполнителей будет рендериться здесь -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна для профиля -->
    <!-- Модалка подписок -->
    <div class="bottom-sheet-overlay" id="subscriptionSheetOverlay">
        <div class="bottom-sheet" id="subscriptionBottomSheet">
            <!-- "Ручка" для свайпа -->
            <div class="bottom-sheet__handle"></div>
            
            <!-- Заголовок -->
            <div class="subscription-header">
                <h2 class="subscription-title">Выберите подписку</h2>
                <p class="subscription-subtitle">Увеличьте свои возможности и заработок</p>
            </div>

            <!-- Контейнер для подписок -->
            <div class="subscriptions-container">
                <div class="subscriptions-list" id="subscriptionsList">
                    <!-- Подписки будут добавляться динамически -->
                </div>
            </div>

            <!-- Футер -->
            <div class="subscription-footer">
                <p class="footer-text">🐱 Мяу! Все подписки продлеваются автоматически</p>
                <button class="confirm-button" id="confirmButton" disabled onclick="confirmSubscription()">
                    Выбрать подписку
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модалка финансов -->
    <div class="vacancies-modal" id="balanceAndPayoutsModal">
        <div class="vacancies-modal__overlay" data-close="true"></div>
        <div class="vacancies-modal__content">
            <div class="modal-content-wrapper">
                <!-- Ручка для свайпа -->
                <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px; margin: 12px auto 0;"></div>
                
                <!-- Header -->
                <div style="position: relative; margin-top: 16px; margin-bottom: 20px;">
                    <div class="vacancies-modal__close" data-close="true" style="position: absolute; top: 0; right: 0; font-size: 24px; cursor: pointer; color: #666;">&times;</div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600; text-align: center; color: #333; font-family: 'Montserrat', sans-serif;">Финансы</h2>
                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666; text-align: center; font-family: 'Montserrat', sans-serif;">Просмотрите чат заказов</p>
                </div>
                
                <!-- Две большие карточки -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <!-- Синяя карточка - Мой баланс -->
                    <div style="background: #1775F1; border-radius: 12px; padding: 20px; text-align: center;">
                        <p id="modalBalance" style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">12 000 Р</p>
                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.9); font-family: 'Montserrat', sans-serif;">Мой баланс</p>
                    </div>
                    
                    <!-- Зеленая карточка - Заработано -->
                    <div style="background: #059669; border-radius: 12px; padding: 20px; text-align: center;">
                        <p id="logistEarnedAmount" style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">42 030 Р</p>
                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.9); font-family: 'Montserrat', sans-serif;">Заработано с ТРУВО</p>
                    </div>
                </div>
                
                <!-- Список транзакций -->
                <div class="operations-history" id="financeOperationsHistory" style="margin-bottom: 20px;">
                    <!-- История операций будет загружена динамически -->
                </div>
                
                <!-- Кнопка "Пополнить баланс" -->
                <button id="topUpBalanceBtn" style="width: 100%; padding: 16px; background: #059669; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">Пополнить баланс</button>
            </div>
        </div>
    </div>

    <div class="vacancies-modal" id="operationsHistoryModal">
        <div class="vacancies-modal__overlay"></div>
        <div class="vacancies-modal__content">
            <div class="vacancies-modal__header">
                <span class="vacancies-modal__tittle">История операций</span>
                <div class="vacancies-modal__close">&times;</div>
            </div>
            <div class="operations-history">
                <!-- История операций будет загружена динамически -->
                    </div>
        </div>
    </div>

    <!-- Модалка поддержки -->
    <div class="vacancies-modal" id="supportSectionModal">
        <div class="vacancies-modal__overlay" data-close="true"></div>
        <div class="vacancies-modal__content">
            <div class="modal-content-wrapper">
                <!-- Ручка для свайпа -->
                <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px; margin: 12px auto 0;"></div>
                
                <!-- Header -->
                <div style="position: relative; margin-top: 16px; margin-bottom: 20px;">
                    <div class="vacancies-modal__close" data-close="true" style="position: absolute; top: 0; right: 0; font-size: 24px; cursor: pointer; color: #666;">&times;</div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600; text-align: center; color: #333; font-family: 'Montserrat', sans-serif;">Поддержка</h2>
                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666; text-align: center; font-family: 'Montserrat', sans-serif;">Ниже указаны все темы по которым вы можете обратиться в поддержку</p>
                </div>
                
                <!-- Список карточек тем -->
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                    <div class="topic-card" style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                        <p class="topic-card__title" style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Проблемы с оплатой</p>
                        <p class="topic-card__description" style="margin: 0; font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">Вопросы по выводу средств и начислениям</p>
                    </div>
                    <div class="topic-card" style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                        <p class="topic-card__title" style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Технические проблемы</p>
                        <p class="topic-card__description" style="margin: 0; font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">Ошибки в работе приложения</p>
                    </div>
                    <div class="topic-card" style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                        <p class="topic-card__title" style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Спорные ситуации</p>
                        <p class="topic-card__description" style="margin: 0; font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">Конфликты с заказчиками и их решение</p>
                    </div>
                    <div class="topic-card" style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                        <p class="topic-card__title" style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Вопросы по заказам</p>
                        <p class="topic-card__description" style="margin: 0; font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">Помощь в уточнении вопросов по заказам</p>
                    </div>
                    <div class="topic-card" style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                        <p class="topic-card__title" style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Вопросы по заказам</p>
                        <p class="topic-card__description" style="margin: 0; font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">Помощь в уточнении вопросов по заказам</p>
                    </div>
                    <div class="topic-card" style="background: #F5F5F5; border-radius: 12px; padding: 16px;">
                        <p class="topic-card__title" style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">Вопросы по заказам</p>
                        <p class="topic-card__description" style="margin: 0; font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">Помощь в уточнении вопросов по заказам</p>
                    </div>
                </div>
                
                <!-- Кнопка "Написать в поддержку" -->
                <button class="support-btn" style="width: 100%; padding: 16px; background: #059669; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                    Написать в поддержку
                </button>
            </div>
        </div>
    </div>

    <!-- ИЗМЕНЕНИЕ: Модалка для оценки исполнителя после завершения заказа (обязательная, нельзя закрыть) -->
    <div class="vacancies-modal" id="ratingModal" style="display: none; z-index: 10000;">
        <div class="vacancies-modal__overlay" style="background: rgba(0, 0, 0, 0.8);"></div>
        <div class="vacancies-modal__content" style="max-width: 500px; width: 90%;">
            <div class="vacancies-modal__header">
                <span class="vacancies-modal__tittle">Оцените исполнителя</span>
                <!-- Кнопка закрытия убрана, модалка обязательная -->
            </div>
            <div style="padding: 20px;">
                <div id="ratingModalContent" style="margin-bottom: 20px;">
                    <p style="margin: 0 0 16px 0; font-size: 16px; color: #333;">
                        Пожалуйста, оцените работу исполнителя по заказу:
                    </p>
                    <p style="margin: 0 0 20px 0; font-size: 14px; color: #666; font-weight: 600;" id="ratingOrderTitle">
                        Заказ #123
                    </p>
                    <p style="margin: 0 0 20px 0; font-size: 14px; color: #666;" id="ratingPerformerName">
                        Исполнитель: Иван Иванов
                    </p>
                </div>
                
                <!-- Оценка Результат -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Результат (1-5):
                    </label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="ratingResult" min="1" max="5" value="5" step="1" style="flex: 1;">
                        <span id="ratingResultValue" style="font-size: 16px; font-weight: 600; color: #1775F1; min-width: 30px;">5</span>
                    </div>
                </div>
                
                <!-- Оценка Пунктуальность -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Пунктуальность (1-5):
                    </label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="ratingPunctuality" min="1" max="5" value="5" step="1" style="flex: 1;">
                        <span id="ratingPunctualityValue" style="font-size: 16px; font-weight: 600; color: #1775F1; min-width: 30px;">5</span>
                    </div>
                </div>
                
                <!-- Оценка Коммуникация -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                        Коммуникация (1-5):
                    </label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="ratingCommunication" min="1" max="5" value="5" step="1" style="flex: 1;">
                        <span id="ratingCommunicationValue" style="font-size: 16px; font-weight: 600; color: #1775F1; min-width: 30px;">5</span>
                    </div>
                </div>
                
                <button class="vacancies-modal__button accept" id="submitRatingBtn" style="width: 100%; margin-top: 20px;">
                    Отправить оценку
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно регистрации (вынесено на уровень body для доступности) -->
    <div class="vacancies-modal" id="registrationModal" style="display: none;">
        <div class="vacancies-modal__overlay" style="background: rgba(0, 0, 0, 0.7);"></div>
        <div class="vacancies-modal__content" style="max-width: 500px; margin: auto; border-radius: 12px; position: relative; background: white;">
            <div class="vacancies-modal__header">
                <span class="vacancies-modal__tittle">Регистрация</span>
                <div class="vacancies-modal__close" onclick="hideRegistrationModal();" style="cursor: pointer;">&times;</div>
            </div>
            <div style="padding: 20px;">
                <form id="registrationForm">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Telegram ID:</label>
                        <input type="number" id="regTelegramId" readonly style="width: 100%; padding: 10px; border: 1px solid #E0E0E0; border-radius: 8px; font-size: 14px; background: #F5F5F5; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Имя пользователя:</label>
                        <input type="text" id="regUsername" placeholder="Введите имя пользователя" required style="width: 100%; padding: 10px; border: 1px solid #E0E0E0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 20px; padding: 12px; background: #F3F4F6; border-radius: 8px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 4px;">Роль:</div>
                        <div style="font-weight: 500; color: #333;">Логист</div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">Подписка:</div>
                        <div style="font-weight: 500; color: #333;">Start (free) - бесплатная</div>
                    </div>
                    <!-- Скрытые поля для автоматической установки роли и подписки -->
                    <input type="hidden" id="regRole" value="logistic">
                    <input type="hidden" id="regSubscriptionTier" value="logist_start">
                    <button type="submit" style="width: 100%; padding: 12px; background: #1775F1; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        /* ---------------------------
           Состояние приложения
        --------------------------- */
        const state = {
            userId: "20011123", // logistic_user_1 (telegram_id: 2001)
            userName: 'Мария',
            profile: {
                subscription_tier: null, // Будет загружаться из API
                daily_collected_count: 0
            },
            orders: [],
            balance: { available: "0₽" },
            operations: [],
            ordersHistory: [],
            currentOrderResponses: [],
            autoRefreshInterval: null,
            currentOrderFilter: "active", // "active" или "finished"
            
            // Конфигурация подписок логистов
            logistTiers: {
                logist_start: {
                    name: "Start (free)",
                    daily_collected_limit: 5,
                    priority_index: 0,
                    plaque: "новый",
                    frame: "grey"
                },
                logist_light: {
                    name: "Light",
                    daily_collected_limit: 15,
                    priority_index: 1,
                    plaque: "активный логист",
                    frame: "blue"
                },
                logist_business: {
                    name: "Business",
                    daily_collected_limit: 30,
                    priority_index: 2,
                    plaque: "надежный партнер",
                    frame: "gold"
                }
            }
        };
        
        // Функция для получения названия подписки логиста
        function getLogistSubscriptionName(tier) {
            if (!tier) return "Start (free)";
            const tierInfo = state.logistTiers[tier];
            return tierInfo ? tierInfo.name : "Start (free)";
        }
        

        /* ---------------------------
           Глобальные переменные для API
        --------------------------- */
        window.API_URL = "https://zaaiwvnohyupxajurnrn.supabase.co/functions/v1/smart-api";
        window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphYWl3dm5vaHl1cHhhanVybnJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MDgwNTUsImV4cCI6MjA3MzA4NDA1NX0.IaQjZ-oxkFzIhiTsACXOEZxL5kAzXh-CdmsDBZth8bI";

        /* ---------------------------
           Универсальный вызов API
        --------------------------- */
        async function callApi(payload = {}) {
            console.log("[callApi] Отправка запроса:", payload);

            if (!window.SUPABASE_ANON_KEY || !window.API_URL) {
                console.error("[callApi] Не заданы SUPABASE_ANON_KEY или API_URL");
                return { success: false, error: "Нет ключа или URL" };
            }

            try {
                const res = await fetch(window.API_URL, {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${window.SUPABASE_ANON_KEY}`,
                        "apikey": window.SUPABASE_ANON_KEY,
                        "x-client-info": "shabashka-frontend"
                    },
                    body: JSON.stringify(payload)
                });

                console.log("[callApi] Ответ сервера, status:", res.status);
                const text = await res.text();
                console.log("[callApi] Ответ сервера, body:", text);

                if (!res.ok) {
                    try { return { success: false, error: JSON.parse(text) }; } catch { return { success: false, error: text || `HTTP ${res.status}` }; }
                }
                try { return JSON.parse(text); } catch { return { success: true, data: text }; }
            } catch (e) {
                console.error("[callApi] Fetch failed:", e);
                return { success: false, error: e.message || String(e) };
            }
        }

        /* ---------------------------
           Real-time подписки
        --------------------------- */
        let realtimeSubscriptions = [];
        
        function initRealtimeSubscriptions() {
            if (!window.supabase) {
                console.warn("[initRealtimeSubscriptions] Supabase клиент не загружен");
                return;
            }
            
            console.log("[initRealtimeSubscriptions] Инициализация real-time подписок для логиста:", state.userId);
            
            // Получаем UUID логиста для подписки на его заказы
            const logistTelegramId = Number(state.userId);
            
            // Подписка на изменения в order_responses (новые отклики на заказы логиста)
            const orderResponsesChannel = window.supabase
                .channel('order_responses_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'order_responses'
                }, async (payload) => {
                    console.log('[Realtime] Изменение в order_responses:', payload);
                    
                    const orderId = payload.new?.order_id || payload.old?.order_id;
                    if (!orderId) return;
                    
                    // Проверяем, относится ли отклик к заказу логиста
                    const order = state.orders.find(o => String(o.id) === String(orderId));
                    if (!order) {
                        // Если заказ не найден в текущем списке, перезагружаем заказы
                        await loadUserOrders();
                        return;
                    }
                    
                    // Если открыто модальное окно с откликами, обновляем их
                    const modal = document.getElementById('responsesModal');
                    if (modal && modal.style.display === 'flex') {
                        // Перезагружаем отклики
                        const responsesResp = await callApi({
                            action: "getOrderResponses",
                            order_id: orderId
                        });
                        
                        if (responsesResp?.success) {
                            state.currentOrderResponses = responsesResp.responses || [];
                            renderEmployees(order);
                        }
                    }
                    
                    // Перезагружаем заказы для обновления счетчика откликов
                    await loadUserOrders();
                })
                .subscribe();
            
            realtimeSubscriptions.push(orderResponsesChannel);
            
            // Подписка на изменения в orders (изменения статусов заказов)
            const ordersChannel = window.supabase
                .channel('orders_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'orders',
                    filter: `created_by=eq.${logistTelegramId}`
                }, async (payload) => {
                    console.log('[Realtime] Изменение в orders:', payload);
                    await loadUserOrders();
                })
                .subscribe();
            
            realtimeSubscriptions.push(ordersChannel);
            
            // Подписка на изменения в transactions (обновление баланса)
            const transactionsChannel = window.supabase
                .channel('transactions_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'transactions',
                    filter: `user_id=eq.${logistTelegramId}`
                }, async (payload) => {
                    console.log('[Realtime] Изменение в transactions:', payload);
                    await loadUserBalance();
                })
                .subscribe();
            
            realtimeSubscriptions.push(transactionsChannel);
            
            // Подписка на изменения в users (обновление баланса)
            const usersChannel = window.supabase
                .channel('users_changes')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'users',
                    filter: `telegram_id=eq.${logistTelegramId}`
                }, async (payload) => {
                    console.log('[Realtime] Изменение в users (баланс):', payload);
                    await loadUserBalance();
                })
                .subscribe();
            
            realtimeSubscriptions.push(usersChannel);
            
            // Подписка на изменения в order_messages (сообщения чата)
            const messagesChannel = window.supabase
                .channel('order_messages_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'order_messages'
                }, async (payload) => {
                    console.log('[Realtime] Изменение в order_messages:', payload);
                    // Если открыт чат для этого заказа, обновляем сообщения
                    if (currentChatOrderId && payload.new?.order_id === currentChatOrderId) {
                        await loadOrderMessages(currentChatOrderId);
                    }
                })
                .subscribe();
            
            realtimeSubscriptions.push(messagesChannel);
            
            console.log("[initRealtimeSubscriptions] Подписки созданы:", realtimeSubscriptions.length);
        }
        
        function cleanupRealtimeSubscriptions() {
            console.log("[cleanupRealtimeSubscriptions] Отключение подписок:", realtimeSubscriptions.length);
            realtimeSubscriptions.forEach(channel => {
                window.supabase?.removeChannel(channel);
            });
            realtimeSubscriptions = [];
        }

        /* ---------------------------
           Инициализация пользователя
        --------------------------- */
        async function initUser() {
            console.log("[initUser] Загрузка данных пользователя:", state.userId);
            
            // Сначала проверяем баланс - если пользователь не найден, показываем форму регистрации
            const balanceResp = await loadUserBalance();
            
            // Если пользователь не найден, не загружаем остальные данные
            if (balanceResp && (balanceResp.user_not_found === true || balanceResp.user_not_found === "true")) {
                console.log("[initUser] ⚠️ Логист не найден, останавливаем инициализацию");
                console.log("[initUser] Форма регистрации должна быть показана");
                // Форма регистрации уже показана в loadUserBalance
                return;
            }
            
            console.log("[initUser] ✅ Логист найден, продолжаем загрузку данных");
            
            await loadUserOrders();
            // Ждем немного, чтобы Supabase клиент точно загрузился
            await new Promise(resolve => setTimeout(resolve, 500));
            // Инициализируем real-time подписки
            initRealtimeSubscriptions();
            // Запускаем автообновление (как резервный вариант)
            startAutoRefresh();
            
            // ИЗМЕНЕНИЕ: Проверяем незавершенные оценки при загрузке страницы
            setTimeout(async () => {
                await checkPendingRatings();
            }, 1000);
        }
        
        // ИЗМЕНЕНИЕ: Функция проверки незавершенных оценок
        async function checkPendingRatings() {
            if (!state.userId) {
                console.warn("[checkPendingRatings] userId не установлен, state.userId:", state.userId);
                return;
            }
            
            console.log("[checkPendingRatings] Проверка незавершенных оценок для логиста:", state.userId);
            
            try {
                const resp = await callApi({
                    action: "getPendingRatings",
                    user_id: state.userId,
                    role: "logist"
                });
                
                console.log("[checkPendingRatings] Ответ API:", resp);
                
                if (resp?.success && resp.pending_ratings && resp.pending_ratings.length > 0) {
                    console.log("[checkPendingRatings] Найдено незавершенных оценок:", resp.pending_ratings.length);
                    console.log("[checkPendingRatings] Первая оценка:", resp.pending_ratings[0]);
                    // Показываем модалку для первой незавершенной оценки
                    const firstRating = resp.pending_ratings[0];
                    showRatingModal(firstRating);
                } else {
                    console.log("[checkPendingRatings] Незавершенных оценок не найдено. resp:", resp);
                    if (resp && !resp.success) {
                        console.error("[checkPendingRatings] Ошибка API:", resp.error);
                    }
                }
            } catch (error) {
                console.error("[checkPendingRatings] Ошибка при проверке незавершенных оценок:", error);
            }
        }
        
        // ИЗМЕНЕНИЕ: Функция показа модалки оценки
        function showRatingModal(ratingData) {
            console.log("[showRatingModal] Показ модалки оценки с данными:", ratingData);
            
            const modal = document.getElementById("ratingModal");
            if (!modal) {
                console.error("[showRatingModal] Модалка не найдена! Проверьте, что элемент #ratingModal существует в DOM");
                return;
            }
            
            console.log("[showRatingModal] Модалка найдена:", modal);
            
            // Заполняем данные в модалке
            const orderTitle = document.getElementById("ratingOrderTitle");
            const performerName = document.getElementById("ratingPerformerName");
            
            if (orderTitle) {
                orderTitle.textContent = ratingData.order_title || `Заказ #${ratingData.order_id}`;
                console.log("[showRatingModal] Заголовок заказа установлен:", orderTitle.textContent);
            } else {
                console.error("[showRatingModal] Элемент #ratingOrderTitle не найден!");
            }
            
            if (performerName) {
                performerName.textContent = `Исполнитель: ${ratingData.performer_name || "Исполнитель"}`;
                console.log("[showRatingModal] Имя исполнителя установлено:", performerName.textContent);
            } else {
                console.error("[showRatingModal] Элемент #ratingPerformerName не найден!");
            }
            
            // Сохраняем данные оценки в модалке
            modal.dataset.notificationId = ratingData.notification_id;
            modal.dataset.orderId = ratingData.order_id;
            modal.dataset.performerId = ratingData.performer_id;
            
            console.log("[showRatingModal] Данные сохранены в модалке:", {
                notificationId: modal.dataset.notificationId,
                orderId: modal.dataset.orderId,
                performerId: modal.dataset.performerId
            });
            
            // Сбрасываем значения слайдеров
            const resultSlider = document.getElementById("ratingResult");
            const punctualitySlider = document.getElementById("ratingPunctuality");
            const communicationSlider = document.getElementById("ratingCommunication");
            
            if (resultSlider) {
                resultSlider.value = 5;
                const valueDisplay = document.getElementById("ratingResultValue");
                if (valueDisplay) valueDisplay.textContent = "5";
            } else {
                console.error("[showRatingModal] Элемент #ratingResult не найден!");
            }
            
            if (punctualitySlider) {
                punctualitySlider.value = 5;
                const valueDisplay = document.getElementById("ratingPunctualityValue");
                if (valueDisplay) valueDisplay.textContent = "5";
            } else {
                console.error("[showRatingModal] Элемент #ratingPunctuality не найден!");
            }
            
            if (communicationSlider) {
                communicationSlider.value = 5;
                const valueDisplay = document.getElementById("ratingCommunicationValue");
                if (valueDisplay) valueDisplay.textContent = "5";
            } else {
                console.error("[showRatingModal] Элемент #ratingCommunication не найден!");
            }
            
            // Показываем модалку
            console.log("[showRatingModal] Показываем модалку, текущий display:", window.getComputedStyle(modal).display);
            modal.style.display = "flex";
            modal.style.zIndex = "10000";
            console.log("[showRatingModal] Модалка должна быть видна, display:", modal.style.display);
            
            // Блокируем прокрутку страницы
            document.body.style.overflow = "hidden";
            
            // Проверяем, что модалка действительно видна
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(modal);
                console.log("[showRatingModal] Проверка видимости модалки через 100ms:", {
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    zIndex: computedStyle.zIndex
                });
            }, 100);
        }
        
        // ИЗМЕНЕНИЕ: Функция отправки оценки
        async function submitRating() {
            const modal = document.getElementById("ratingModal");
            if (!modal) {
                console.error("[submitRating] Модалка не найдена");
                return;
            }
            
            const notificationId = modal.dataset.notificationId;
            const orderId = modal.dataset.orderId;
            const performerId = modal.dataset.performerId;
            
            if (!orderId || !performerId) {
                alert("Ошибка: данные оценки не найдены");
                return;
            }
            
            const result = parseInt(document.getElementById("ratingResult")?.value || 5);
            const punctuality = parseInt(document.getElementById("ratingPunctuality")?.value || 5);
            const communication = parseInt(document.getElementById("ratingCommunication")?.value || 5);
            
            console.log("[submitRating] Отправка оценки:", {
                order_id: orderId,
                performer_id: performerId,
                result,
                punctuality,
                communication
            });
            
            // Отправляем оценку
            const resp = await callApi({
                action: "ratePerformer",
                order_id: orderId,
                logist_id: state.userId,
                performer_id: performerId,
                result,
                punctuality,
                communication
            });
            
            if (resp?.success) {
                console.log("[submitRating] Оценка успешно отправлена");
                
                // Помечаем уведомление как прочитанное
                if (notificationId) {
                    await callApi({
                        action: "markRatingCompleted",
                        notification_id: notificationId
                    });
                }
                
                // Скрываем модалку
                modal.style.display = "none";
                document.body.style.overflow = "";
                
                // Проверяем, есть ли еще незавершенные оценки
                await checkPendingRatings();
            } else {
                const errorMsg = resp?.error?.message || resp?.error || "Неизвестная ошибка";
                alert("Ошибка при отправке оценки: " + errorMsg);
            }
        }

        /* ---------------------------
           Автообновление данных (polling)
        --------------------------- */
        function startAutoRefresh() {
            // Останавливаем предыдущий интервал, если он есть
            if (state.autoRefreshInterval) {
                clearInterval(state.autoRefreshInterval);
            }

            // Обновляем данные каждые 2 секунды для real-time эффекта (более частое обновление для откликов)
            state.autoRefreshInterval = setInterval(async () => {
                console.log("[AutoRefresh] Обновление данных...");
                await loadUserOrders();
                await loadUserBalance();
                
                // Если открыто модальное окно с откликами, обновляем их тоже
                const modal = document.getElementById('responsesModal');
                if (modal && modal.style.display === 'flex') {
                    const orderId = state.currentOrderId;
                    if (orderId) {
                        const responsesResp = await callApi({
                            action: "getOrderResponses",
                            order_id: orderId
                        });
                        
                        if (responsesResp?.success) {
                            state.currentOrderResponses = responsesResp.responses || [];
                            const order = state.orders.find(o => String(o.id) === String(orderId));
                            if (order) {
                                renderEmployees(order);
                            }
                        }
                    }
                }
            }, 2000); // 2 секунды для более быстрого обновления откликов
        }

        /* ---------------------------
           Загрузка заказов пользователя (логиста)
        --------------------------- */
        async function loadUserOrders() {
            if (!state.userId) {
                console.warn("[loadUserOrders] userId ещё не инициализирован");
                return;
            }

            console.log("[loadUserOrders] Загрузка заказов для логиста:", {
                userId: state.userId,
                userId_type: typeof state.userId,
                userId_number: Number(state.userId)
            });

            const resp = await callApi({
                action: "getLogistOrders",
                logist_id: state.userId
            });
            
            console.log("[loadUserOrders] Получено заказов:", resp?.orders?.length || 0);
            if (resp?.orders && resp.orders.length > 0) {
                console.log("[loadUserOrders] Первые 3 заказа:", resp.orders.slice(0, 3).map(o => ({
                    id: o.id,
                    title: o.title,
                    created_by: o.created_by,
                    created_by_type: typeof o.created_by
                })));
            }

            if (resp?.success) {
                // ДОПОЛНИТЕЛЬНАЯ ФИЛЬТРАЦИЯ НА ФРОНТЕНДЕ - на всякий случай
                const logistId = Number(state.userId);
                const filteredOrders = (resp.orders || []).filter(order => {
                    const orderCreatedBy = Number(order.created_by);
                    const matches = orderCreatedBy === logistId;
                    if (!matches) {
                        console.warn(`[loadUserOrders] ❌ Отфильтрован заказ на фронтенде: ${order.id}, created_by=${orderCreatedBy} !== logist_id=${logistId}`);
                    }
                    return matches;
                });
                
                console.log("[loadUserOrders] Фильтрация на фронтенде:", {
                    received: resp.orders?.length || 0,
                    filtered: filteredOrders.length,
                    removed: (resp.orders?.length || 0) - filteredOrders.length
                });
                
                state.orders = filteredOrders;
                renderOrders();
            } else {
                console.error("[loadUserOrders] Не удалось загрузить заказы:", resp?.error);
                state.orders = [];
                renderOrders();
            }
        }

        /* ---------------------------
           Загрузка баланса пользователя
        --------------------------- */
        async function loadUserBalance() {
            if (!state.userId) {
                console.warn("[loadUserBalance] userId ещё не инициализирован");
                return;
            }

            const resp = await callApi({
                action: "getUserBalance",
                user_id: state.userId
            });

            console.log("[loadUserBalance] Ответ:", resp);
            console.log("[loadUserBalance] resp.user_not_found:", resp?.user_not_found, typeof resp?.user_not_found);

            if (resp?.success) {
                // Проверяем, не найден ли пользователь
                const isUserNotFound = resp.user_not_found === true || resp.user_not_found === "true" || resp.user_not_found === 1;
                
                console.log("[loadUserBalance] isUserNotFound:", isUserNotFound);
                console.log("[loadUserBalance] Проверка user_not_found:", {
                    value: resp.user_not_found,
                    type: typeof resp.user_not_found,
                    isTrue: resp.user_not_found === true,
                    isStringTrue: resp.user_not_found === "true",
                    isUserNotFound: isUserNotFound
                });
                
                if (isUserNotFound) {
                    console.log("[loadUserBalance] ✅✅✅ Логист не найден, показываем форму регистрации");
                    
                    // Пытаемся получить данные пользователя из URL параметров
                    const urlParams = new URLSearchParams(window.location.search);
                    const userDataParam = urlParams.get('userData');
                    let userData = null;
                    
                    if (userDataParam) {
                        try {
                            userData = JSON.parse(decodeURIComponent(userDataParam));
                            console.log("[loadUserBalance] Данные пользователя из URL:", userData);
                        } catch (e) {
                            console.error("[loadUserBalance] Ошибка парсинга userData:", e);
                        }
                    }
                    
                    // Показываем форму регистрации с задержкой, чтобы DOM был готов
                    console.log("[loadUserBalance] Вызов showRegistrationModal через 200ms");
                    setTimeout(() => {
                        console.log("[loadUserBalance] Вызываем showRegistrationModal сейчас");
                        showRegistrationModal(userData);
                    }, 200);
                    
                    return { user_not_found: true };
                }
                
                state.balance = {
                    available: (resp.balance?.available ?? 0) + "₽"
                };
                state.operations = resp.transactions || [];
                
                console.log("[loadUserBalance] Загружено операций:", state.operations.length);
                console.log("[loadUserBalance] Первые 3 операции:", state.operations.slice(0, 3));
                
                // Обновляем информацию о пользователе если она пришла
                if (resp.user) {
                    console.log("[loadUserBalance] Данные пользователя:", resp.user);
                    // Обновляем имя пользователя из БД
                    const username = resp.user.username || resp.user.name || null;
                    if (username) {
                        console.log("[loadUserBalance] Обновляем имя на:", username);
                        state.userName = username;
                        // Обновляем отображение имени в заголовках - ищем все элементы .header__name
                        updateLogistName(username);
                    } else {
                        console.warn("[loadUserBalance] username не найден в ответе:", resp.user);
                    }
                    state.profile.subscription_tier = resp.user.subscription_tier || null;
                    state.profile.daily_collected_count = resp.user.daily_collected_count || 0;
                    // ИЗМЕНЕНИЕ: Сохраняем рейтинг и характеристики для логиста
                    state.profile.rating = resp.user.rating || 50;
                    state.profile.characteristics = resp.user.characteristics || null;
                    
                    // Обновляем отображение подписки
                    const subscriptionStatus = getLogistSubscriptionName(state.profile.subscription_tier);
                    const statusEl1 = document.getElementById('logistSubscriptionStatus');
                    const statusEl2 = document.getElementById('logistSubscriptionStatusCreate');
                    if (statusEl1) statusEl1.textContent = subscriptionStatus;
                    if (statusEl2) statusEl2.textContent = subscriptionStatus;
                    
                    // ИЗМЕНЕНИЕ: Отображаем рейтинг и характеристики в профиле логиста
                    renderLogistRating();
                    
                    // Скрываем/показываем требования в зависимости от подписки
                    updateRequirementsVisibility(state.profile.subscription_tier);
                } else {
                    console.warn("[loadUserBalance] resp.user не найден в ответе:", resp);
                }
                
                renderBalance();
                const balanceEl = document.querySelector('#balance');
                const activeOrdersEl = document.querySelector('#activeOrders');
                const availableOrdersEl = document.querySelector('#availableOrders');
                if (balanceEl) balanceEl.innerHTML = state.balance.available;
                // Подсчитываем активные заказы (не завершенные)
                const activeOrdersCount = state.orders.filter(o => o.status !== "completed").length;
                if (activeOrdersEl) activeOrdersEl.innerHTML = activeOrdersCount;
                // Доступно заказов - это лимит подписки минус созданные сегодня
                // Пока просто показываем активные заказы, потом доработаем
                if (availableOrdersEl) {
                    const tier = state.logistTiers[state.profile.subscription_tier] || state.logistTiers.logist_start;
                    const dailyLimit = tier.daily_collected_limit || 5;
                    const availableCount = Math.max(0, dailyLimit - state.profile.daily_collected_count);
                    availableOrdersEl.innerHTML = availableCount;
                }
                return resp;
            } else {
                console.error("[loadUserBalance] Не удалось загрузить баланс:", resp?.error);
                return resp;
            }
        }

        /* ---------------------------
           Рендер заказов
        --------------------------- */
        function renderOrders() {
            const container = document.getElementById("orders-container");
            if (!container) return;

            container.innerHTML = "";

            if (!state.orders || state.orders.length === 0) {
                const empty = document.createElement("div");
                empty.className = "no-orders";
                empty.textContent = "Заказов не найдено.";
                container.appendChild(empty);
                return;
            }

            // ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА ПЕРЕД РЕНДЕРИНГОМ
            const logistId = Number(state.userId);
            let validOrders = state.orders.filter(order => {
                const orderCreatedBy = Number(order.created_by);
                const matches = orderCreatedBy === logistId;
                if (!matches) {
                    console.error(`[renderOrders] ❌ КРИТИЧЕСКАЯ ОШИБКА: Попытка отрендерить заказ другого логиста! ${order.id}, created_by=${orderCreatedBy} !== logist_id=${logistId}`);
                }
                return matches;
            });
            
            if (validOrders.length !== state.orders.length) {
                console.error(`[renderOrders] ⚠️ ОТФИЛЬТРОВАНО ${state.orders.length - validOrders.length} заказов других логистов!`);
            }
            
            // Фильтрация по статусу (активные или завершенные)
            if (state.currentOrderFilter === "finished") {
                validOrders = validOrders.filter(order => order.status === "completed");
            } else {
                // Активные заказы - все кроме completed
                validOrders = validOrders.filter(order => order.status !== "completed");
            }
            
            // Показываем ВСЕ заказы, даже если у них нет откликов (responsesCount = 0)
            // Раньше была фильтрация по responsesCount > 0, но это скрывало новые заказы
            
            if (validOrders.length === 0) {
                const empty = document.createElement("div");
                empty.className = "no-orders";
                empty.textContent = state.currentOrderFilter === "finished" ? "Завершенных заказов нет." : "Активных заказов нет.";
                container.appendChild(empty);
                return;
            }
            
            validOrders.forEach(order => {
                const div = document.createElement("div");
                div.className = "vacancies__item";
                div.dataset.id = order.id;

                // Используем отклики из самого заказа
                const responsesCount = order.responses ? order.responses.length : 0;
                const requiredSlots = order.required_slots || order.people_needed || 1;
                const maxResponses = requiredSlots * 2;
                const isDisabled = false;

                // Определяем рамочку для заказа на основе premium и подписки логиста
                const tierInfo = state.logistTiers[state.profile.subscription_tier] || state.logistTiers.logist_start;
                let frameStyle = 'border: 1px solid #ccc;'; // Серая по умолчанию
                if (order.premium) {
                    frameStyle = 'border: 2px solid #FFD700; box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);';
                } else if (tierInfo.frame === 'gold') {
                    frameStyle = 'border: 2px solid #FFD700; box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);';
                } else if (tierInfo.frame === 'blue') {
                    frameStyle = 'border: 2px solid #1775F1; box-shadow: 0 0 6px rgba(23, 117, 241, 0.2);';
                }
                div.style.cssText = frameStyle + ' border-radius: 8px; padding: 12px; margin-bottom: 12px;';
                
                // Метро в шорт-версии
                const metroInfo = order.metro_station ? `<div style="margin-top: 4px; font-size: 12px; color: #666; display: flex; align-items: center;">
                    <svg style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ${escapeHtml(order.metro_station)}
                </div>` : '';

                // Остальной код рендера остается таким же...
                div.innerHTML = `
            <span class="vacancies__title">${escapeHtml(order.title || "Без названия")}</span>
            ${order.premium ? '<span style="background: #FFD700; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 8px;">PREMIUM</span>' : ''}
            <span class="vacancies__description">${escapeHtml(order.description || "")}</span>
            ${metroInfo}
            <div class="vacancies__info">
                <div class="vacancies__info-item">
                    <div class="vacancies__info-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 21C15.5 17.4 19 14.1764 19 10.2C19 6.22355 15.7764 3 12 3C8.22355 3 5 6.22355 5 10.2C5 14.1764 8.5 17.4 12 21Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="vacancies__info-text">${escapeHtml(order.location || "-")}</span>
                </div>
                <div class="vacancies__time-people">
                    <div class="vacancies__info-item">
                        <div class="vacancies__info-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="vacancies__info-text">${escapeHtml(order.duration_hours || 0)} часа</span>
                    </div>
                    <div class="vacancies__info-item">
                        <div class="vacancies__info-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13M16 3.13C16.8604 3.3503 17.623 3.8507 18.1676 4.55231C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89317 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88M13 7C13 9.20914 11.2091 11 9 11C6.79086 11 5 9.20914 5 7C5 4.79086 6.79086 3 9 3C11.2091 3 13 4.79086 13 7Z" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="vacancies__info-text">${escapeHtml(requiredSlots)} человек</span>
                    </div>
                </div>
            </div>
            <div class="vacancies__container">
                <div class="vacancies__container-customer">
                    <span class="vacancies__customer">${order.status === "completed" ? "Завершен" : `${responsesCount} откликов`}</span>
                    <span class="vacancies__time">${formatTimeAgo(order.created_at)}</span>
                </div>
                <div class="vacancies__container-order">
                    <span class="vacancies__price">${escapeHtml(order.wage_per_hour || 0)}р/час</span>
                    ${order.status === "completed" ? '' : `<button class="vacancies__button" data-order-id="${order.id}">
                        Открыть панель
                    </button>`}
                </div>
            </div>
        `;

                // Для завершенных заказов не добавляем обработчик кнопки
                if (order.status !== "completed") {
                const button = div.querySelector(".vacancies__button");
                if (button && !isDisabled) {
                    button.addEventListener("click", () => openOrderModal(order.id));
                    }
                }

                if (isDisabled) {
                    container.appendChild(div);
                } else {
                    container.prepend(div);
                }
            });
        }

        /* ---------------------------
           Открытие модального окна с откликами
        --------------------------- */
        // Сохраняем текущий открытый заказ для обновления
        state.currentOrderId = null;
        
        async function openOrderModal(orderId) {
            state.currentOrderId = orderId;
            const modal = document.getElementById("responsesModal");
            const order = state.orders.find(o => String(o.id) === String(orderId));

            if (!modal || !order) return;

            // Загружаем отклики на заказ
            const responsesResp = await callApi({
                action: "getOrderResponses",
                order_id: orderId
            });

            if (responsesResp?.success) {
                state.currentOrderResponses = responsesResp.responses || [];
                console.log("[openOrderModal] Загружено откликов:", state.currentOrderResponses.length);
            } else {
                console.error("[openOrderModal] Не удалось загрузить отклики:", responsesResp?.error);
                state.currentOrderResponses = [];
            }

            // Рендерим исполнителей
            renderEmployees(order);

            // Открываем модалку
            modal.style.display = "flex";
            modal.classList.add("modal-open");
            document.body.style.overflow = "hidden"; // Block scroll
            
            // Обработчики закрытия
            const overlay = modal.querySelector(".vacancies-modal__overlay");
            const closeBtn = modal.querySelector(".vacancies-modal__close");
            
            const closeModalFunc = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                modal.classList.remove("modal-open");
                modal.style.display = "none";
                document.body.style.overflow = ""; // Unblock scroll
            };
            
            if (overlay) {
                overlay.onclick = closeModalFunc;
            }
            if (closeBtn) {
                closeBtn.onclick = closeModalFunc;
            }
            
            // Обработчик для data-close атрибутов
            modal.querySelectorAll('[data-close="true"]').forEach(el => {
                el.addEventListener('click', closeModalFunc);
            });
        }
        
        /* ---------------------------
           Чат заказа
        --------------------------- */
        let currentChatOrderId = null;
        let chatRefreshInterval = null;
        
        async function initOrderChatLogist(order) {
            const modal = document.getElementById('orderChatModal');
            if (!modal) {
                console.error("[initOrderChatLogist] Модальное окно чата не найдено");
                return;
            }
            
            // Показываем модальное окно
            modal.classList.add("modal-open");
            modal.style.display = 'flex';
            document.body.style.overflow = "hidden";
            
            // Обновляем заголовок
            const subtitle = document.getElementById('orderChatSubtitle');
            if (subtitle) {
                subtitle.textContent = `Заказ #${order.id}`;
            }
            
            // Всегда пытаемся загрузить чат, но показываем разные сообщения в зависимости от статуса
            console.log("[initOrderChatLogist] Статус заказа:", order.status);
            currentChatOrderId = order.id;
            await loadOrderMessagesLogist(order.id);
            
            if (order.status === 'in_progress') {
                startChatRefreshLogist(order.id);
            }
        }
        
        function closeOrderChatLogist() {
            const modal = document.getElementById('orderChatModal');
            if (modal) {
                modal.classList.remove("modal-open");
                modal.style.display = 'none';
                document.body.style.overflow = "";
            }
            currentChatOrderId = null;
            stopChatRefreshLogist();
        }
        
        async function loadOrderMessagesLogist(orderId) {
            console.log("[loadOrderMessagesLogist] Загрузка сообщений для заказа:", orderId);
            const messagesContainer = document.getElementById('orderChatMessagesLogist');
            if (!messagesContainer) {
                console.error("[loadOrderMessagesLogist] Контейнер сообщений не найден");
                return;
            }
            
            const resp = await callApi({
                action: "getOrderMessages",
                order_id: orderId
            });
            
            console.log("[loadOrderMessagesLogist] Ответ от API:", resp);
            
            if (resp?.success) {
                console.log("[loadOrderMessagesLogist] Сообщения получены:", resp.messages?.length || 0);
                console.log("[loadOrderMessagesLogist] Чат доступен:", resp.chat_available);
                renderChatMessagesLogist(resp.messages || []);
                
                // Если чат недоступен, блокируем ввод
                const chatInput = document.getElementById('orderChatInputLogist');
                const chatSendBtn = document.getElementById('orderChatSendBtnLogist');
                
                if (!resp.chat_available) {
                    if (chatInput) {
                        chatInput.disabled = true;
                        chatInput.placeholder = 'Чат недоступен для этого заказа';
                        chatInput.style.background = '#F5F5F5';
                    }
                    if (chatSendBtn) {
                        chatSendBtn.disabled = true;
                        chatSendBtn.style.opacity = '0.5';
                    }
                } else {
                    if (chatInput) {
                        chatInput.disabled = false;
                        chatInput.placeholder = 'Введите сообщение...';
                        chatInput.style.background = 'white';
                    }
                    if (chatSendBtn) {
                        chatSendBtn.disabled = false;
                        chatSendBtn.style.opacity = '1';
                    }
                }
            } else {
                console.log("[loadOrderMessagesLogist] Ошибка загрузки сообщений:", resp?.error);
                messagesContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Ошибка загрузки сообщений</p>';
            }
        }
        
        function renderChatMessagesLogist(messages) {
            console.log("[renderChatMessagesLogist] Рендер сообщений:", messages?.length || 0, messages);
            const messagesContainer = document.getElementById('orderChatMessagesLogist');
            if (!messagesContainer) {
                console.error("[renderChatMessagesLogist] Контейнер сообщений не найден");
                return;
            }
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Нет сообщений</p>';
                return;
            }
            
            // Сортируем сообщения по дате (старые сначала)
            const sortedMessages = [...messages].sort((a, b) => {
                const normalizedA = normalizeUTCDate(a.created_at);
                const normalizedB = normalizeUTCDate(b.created_at);
                return new Date(normalizedA) - new Date(normalizedB);
            });
            
            let html = '';
            let lastDate = '';
            
            sortedMessages.forEach(msg => {
                const normalizedDate = normalizeUTCDate(msg.created_at);
                const messageDate = formatDate(normalizedDate);
                
                // Добавляем разделитель даты если дата изменилась
                if (messageDate !== lastDate) {
                    html += `
                        <div style="text-align: center; margin: 16px 0; color: #999; font-size: 12px; font-family: 'Montserrat', sans-serif;">
                            ${messageDate}
                        </div>
                    `;
                    lastDate = messageDate;
                }
                
                const isMyMessage = Number(msg.user_id) === Number(state.userId);
                const time = new Date(normalizedDate).toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                html += `
                    <div style="display: flex; ${isMyMessage ? 'justify-content: flex-end' : 'justify-content: flex-start'}; margin-bottom: 12px;">
                        <div style="
                            max-width: 70%; 
                            padding: 12px 16px; 
                            border-radius: 16px; 
                            ${isMyMessage 
                                ? 'background: #1775F1; color: white; border-bottom-right-radius: 4px;' 
                                : 'background: #F5F5F5; color: #333; border-bottom-left-radius: 4px;'
                            }
                            font-family: 'Montserrat', sans-serif;
                            font-size: 14px;
                            line-height: 1.4;
                            word-wrap: break-word;
                        ">
                            <div style="margin-bottom: 4px;">${escapeHtml(msg.message)}</div>
                            <div style="font-size: 11px; opacity: 0.7; text-align: right;">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            messagesContainer.innerHTML = html;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function sendOrderMessageLogist(orderId) {
            console.log("[sendOrderMessageLogist] Отправка сообщения для заказа:", orderId);
            const chatInput = document.getElementById('orderChatInputLogist');
            if (!chatInput) {
                console.error("[sendOrderMessageLogist] Поле ввода не найдено");
                return;
            }
            
            const message = chatInput.value.trim();
            if (!message) {
                console.log("[sendOrderMessageLogist] Пустое сообщение");
                return;
            }
            
            console.log("[sendOrderMessageLogist] Отправляем сообщение:", message);
            
            const resp = await callApi({
                action: "sendOrderMessage",
                order_id: orderId,
                message: message
            });
            
            console.log("[sendOrderMessageLogist] Ответ от API:", resp);
            
            if (resp?.success) {
                chatInput.value = '';
                await loadOrderMessagesLogist(orderId);
            } else {
                console.error("[sendOrderMessageLogist] Ошибка отправки:", resp?.error);
                alert('Ошибка отправки сообщения: ' + (resp?.error || 'Неизвестная ошибка'));
            }
        }
        
        function startChatRefreshLogist(orderId) {
            stopChatRefreshLogist();
            chatRefreshInterval = setInterval(() => {
                if (currentChatOrderId === orderId) {
                    loadOrderMessagesLogist(orderId);
                }
            }, 3000);
        }
        
        function stopChatRefreshLogist() {
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
                chatRefreshInterval = null;
            }
        }
        
        // Утилиты для работы с датами (скопированы из user.html)
        function normalizeUTCDate(dateString) {
            if (!dateString) return null;
            
            // Если это уже объект Date, возвращаем как есть
            if (dateString instanceof Date) return dateString;
            
            if (typeof dateString !== 'string') return dateString;
            
            let normalized = dateString.trim();
            
            // Если строка уже содержит указание часового пояса (Z или +HH:MM/-HH:MM), возвращаем как есть
            if (normalized.includes('Z') || normalized.match(/[+-]\d{2}:\d{2}$/)) {
                return normalized;
            }
            
            // Обрабатываем различные форматы дат из PostgreSQL/Supabase
            // Убираем миллисекунды/микросекунды, если есть (всё что после секунд, включая точку)
            normalized = normalized.replace(/\.\d+(?=[Z+\-]|$)/, '');
            
            // Заменяем пробел на 'T' для ISO формата (если есть пробел между датой и временем)
            normalized = normalized.replace(/^(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2})/, '$1T$2');
            
            // Если формат "YYYY-MM-DD" (только дата без времени), добавляем время
            if (/^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                normalized += 'T00:00:00';
            }
            
            // КРИТИЧЕСКИ ВАЖНО: Добавляем 'Z' в конец, чтобы явно указать UTC
            // Без 'Z' JavaScript интерпретирует строку как локальное время пользователя
            // С 'Z' JavaScript интерпретирует строку как UTC и автоматически конвертирует в локальное время
            if (!normalized.endsWith('Z') && !normalized.match(/[+-]\d{2}:\d{2}$/)) {
                // Проверяем, что строка имеет формат с временем (содержит 'T' и время)
                if (/T\d{2}:\d{2}:\d{2}$/.test(normalized)) {
                    normalized += 'Z';
                } else if (/^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                    // Если только дата, добавляем время и Z
                    normalized += 'T00:00:00Z';
                }
            }
            
            return normalized;
        }
        
        // Форматирование полной даты с учетом UTC и локального времени
        function formatDate(dateString, fullFormat = false) {
            if (!dateString) return 'не указано';
            
            // Нормализуем строку даты: если нет указания часового пояса, добавляем 'Z' (UTC)
            const normalizedDateString = normalizeUTCDate(dateString);
            if (!normalizedDateString) return 'не указано';
            
            // Парсим дату из UTC (с сервера приходит в UTC)
            // Когда мы создаем Date из строки с 'Z', JavaScript автоматически конвертирует UTC в локальное время
            const date = new Date(normalizedDateString);
            
            // Проверяем валидность даты
            if (isNaN(date.getTime())) {
                console.warn('[formatDate] Невалидная дата:', dateString, '->', normalizedDateString);
                return 'не указано';
            }
            
            // toLocaleString автоматически использует локальный часовой пояс браузера
            // Не нужно явно указывать timeZone, так как по умолчанию используется локальный часовой пояс
            try {
                if (fullFormat) {
                    return date.toLocaleString('ru-RU', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                } else {
                    return date.toLocaleString('ru-RU', { 
                        day: 'numeric', 
                        month: 'numeric', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            } catch (error) {
                console.warn('[formatDate] Ошибка форматирования даты:', error);
                return 'не указано';
            }
        }
        
        
        // Функция открытия чата заказа
        function openOrderChat(orderId) {
            console.log("[openOrderChat] Открытие чата для заказа:", orderId);
            
            // Закрываем модалку откликов
            const responsesModal = document.getElementById("responsesModal");
            if (responsesModal) {
                responsesModal.style.display = "none";
                document.body.style.overflow = "";
            }
            
            // Находим заказ и открываем модальное окно чата
            const order = state.orders.find(o => String(o.id) === String(orderId));
            if (order) {
                currentChatOrderId = orderId;
                initOrderChatLogist(order);
            }
        }
        
        // Функция отклонения исполнителя
        async function rejectEmployee(employeeId, orderId) {
            if (!confirm('Отклонить этого исполнителя?')) return;
            
            console.log("[rejectEmployee] Отклонение исполнителя:", { employeeId, orderId });
            
            const resp = await callApi({
                action: "rejectResponse",
                response_id: employeeId,
                order_id: orderId,
                logist_id: state.userId
            });
            
            if (resp?.success) {
                console.log("[rejectEmployee] Исполнитель отклонен");
                // Обновляем список откликов
                await loadOrderResponses(orderId);
                const order = state.orders.find(o => String(o.id) === String(orderId));
                if (order) {
                    renderEmployees(order);
                }
            } else {
                console.error("[rejectEmployee] Ошибка отклонения:", resp?.error);
                alert("Ошибка при отклонении исполнителя: " + (resp?.error || "Неизвестная ошибка"));
            }
        }

        // Функция завершения заказа
        // Функция завершения заказа
        async function completeOrder(orderId) {
            if (!confirm("Вы уверены, что хотите завершить заказ? Средства будут переведены исполнителям (замороженные средства + оплата за работу).")) {
                return;
            }

            console.log("[completeOrder] Завершение заказа:", orderId);

            const resp = await callApi({
                action: "finalizeOrder",
                order_id: orderId,
                logist_id: state.userId
            });

            console.log("[completeOrder] Ответ сервера:", resp);

            if (resp?.success) {
                let successMessage = "Заказ успешно завершен!\n\n";
                
                if (resp.payouts && resp.payouts.length > 0) {
                    successMessage += "Реквизиты для перевода:\n\n";
                    resp.payouts.forEach((payout, index) => {
                        const performerName = payout.performer_name || "Исполнитель";
                        successMessage += `${index + 1}. ${performerName}\n`;
                        successMessage += `   Сумма к выплате: ${payout.net_amount}₽\n`;
                        successMessage += `   Метод выплаты: ${payout.payout_method === 'card' ? 'Карта' : payout.payout_method === 'sbp' ? 'СБП' : payout.payout_method}\n`;
                        if (payout.payout_details) {
                            successMessage += `   Реквизиты: ${payout.payout_details}\n`;
                        }
                        successMessage += "\n";
                    });
                } else {
                    successMessage += `Выплат: ${resp.payout_count || 0} чел.`;
                }

                alert(successMessage);

                // Немедленно обновляем данные
                await loadUserOrders();
                await loadUserBalance();

                // Закрываем модальное окно
                closeModal(document.getElementById('responsesModal'));
                
                // ИЗМЕНЕНИЕ: После завершения заказа проверяем незавершенные оценки
                setTimeout(async () => {
                    await checkPendingRatings();
                }, 1000);
            } else {
                const errorMsg = resp?.error?.message || resp?.error || "Неизвестная ошибка";
                alert("Ошибка при завершении заказа: " + errorMsg);
            }
        }
        /* ---------------------------
           Рендер исполнителей в модальном окне
        --------------------------- */
        // Текущая активная вкладка
        let currentOrderTab = 'pending';
        
        // Функция переключения вкладок
        function switchOrderTab(tab) {
            currentOrderTab = tab;
            
            // Обновляем стили вкладок
            document.querySelectorAll('.order-tab').forEach(tabBtn => {
                if (tabBtn.dataset.tab === tab) {
                    tabBtn.style.background = 'white';
                    tabBtn.style.color = '#333';
                    tabBtn.classList.add('active');
                } else {
                    tabBtn.style.background = 'transparent';
                    tabBtn.style.color = '#666';
                    tabBtn.classList.remove('active');
                }
            });
            
            // Перерендериваем исполнителей
            const order = state.orders.find(o => String(o.id) === String(state.currentOrderId));
            if (order) {
                renderEmployees(order);
            }
        }

        function renderEmployees(order) {
            const container = document.getElementById("employeesContainer");
            const tabsContainer = document.getElementById("orderTabs");
            if (!container) return;

            container.innerHTML = "";

            // Группируем исполнителей по статусам
            const pendingEmployees = state.currentOrderResponses.filter(r => r.status === 'pending');
            const acceptedEmployees = state.currentOrderResponses.filter(r => r.status === 'accepted');
            const workingEmployees = state.currentOrderResponses.filter(r => r.status === 'working' || r.status === 'in_progress' || r.status === 'confirmed');
            
            // Проверяем статус заказа и количество людей
            const requiredSlots = order.required_slots || 1;
            const isOrderFull = workingEmployees.length >= requiredSlots;
            const isOrderInProgress = order.status === 'in_progress';
            
            // Показываем вкладки всегда
            if (tabsContainer) tabsContainer.style.display = 'flex';
            
            // Если заказ в статусе "in_progress", добавляем кнопки чата и завершения вверху
            if (isOrderInProgress && isOrderFull) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 16px; margin-bottom: 16px; background: #f0f9ff; border-radius: 12px; border: 1px solid #0ea5e9;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #0369a1; font-family: 'Montserrat', sans-serif;">
                            ✅ Заказ выполняется
                        </h3>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="openOrderChat('${order.id}')" style="
                                background: #1775F1; 
                                color: white; 
                                border: none; 
                                padding: 12px 20px; 
                                border-radius: 8px; 
                                font-size: 14px; 
                                font-weight: 600; 
                                cursor: pointer;
                                font-family: 'Montserrat', sans-serif;
                            ">
                                💬 Чат заказа
                            </button>
                            <button onclick="completeOrder('${order.id}')" style="
                                background: #059669; 
                                color: white; 
                                border: none; 
                                padding: 12px 20px; 
                                border-radius: 8px; 
                                font-size: 14px; 
                                font-weight: 600; 
                                cursor: pointer;
                                font-family: 'Montserrat', sans-serif;
                            ">
                                ✅ Завершить
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Заказ еще не в выполнении - показываем кнопку отмены
                container.innerHTML = `
                    <div style="text-align: center; padding: 12px; margin-bottom: 16px;">
                        <button onclick="cancelOrder('${order.id}')" style="
                            background: #f44336; 
                            color: white; 
                            border: none; 
                            padding: 10px 20px; 
                            border-radius: 8px; 
                            font-size: 14px; 
                            font-weight: 600; 
                            cursor: pointer;
                            font-family: 'Montserrat', sans-serif;
                        ">
                            🗑️ Отменить заказ
                        </button>
                    </div>
                `;
            }
            
            // Обновляем счетчики на вкладках
            document.querySelector('[data-tab="pending"]').textContent = `Отклики (${pendingEmployees.length})`;
            document.querySelector('[data-tab="accepted"]').textContent = `Подтверждают (${acceptedEmployees.length})`;
            document.querySelector('[data-tab="working"]').textContent = `В работе (${workingEmployees.length})`;
            
            // Показываем исполнителей в зависимости от активной вкладки
            let employeesToShow = [];
            if (currentOrderTab === 'pending') {
                employeesToShow = pendingEmployees;
            } else if (currentOrderTab === 'accepted') {
                employeesToShow = acceptedEmployees;
            } else if (currentOrderTab === 'working') {
                employeesToShow = workingEmployees;
            }
            
            if (employeesToShow.length === 0) {
                const emptyMessages = {
                    'pending': 'Нет новых откликов',
                    'accepted': 'Никто не подтверждает',
                    'working': 'Никто не работает'
                };
                container.innerHTML = `<p style="text-align: center; color: #666; padding: 20px; font-family: 'Montserrat', sans-serif;">${emptyMessages[currentOrderTab]}</p>`;
                return;
            }

            // Функция сортировки исполнителей
            const sortEmployees = (employees) => {
                return employees.sort((a, b) => {
                    // Сначала по приоритету подписки (gold > silver > free)
                    const aTier = a.users?.subscription_tier || a.subscription_tier || 'free_performer';
                    const bTier = b.users?.subscription_tier || b.subscription_tier || 'free_performer';
                    const tierPriority = { gold: 3, silver: 2, free_performer: 1 };
                    const aPriority = tierPriority[aTier] || 1;
                    const bPriority = tierPriority[bTier] || 1;
                    if (aPriority !== bPriority) return bPriority - aPriority;

                    // Затем по рейтингу
                    const aRating = a.users?.rating || a.rating || 0;
                    const bRating = b.users?.rating || b.rating || 0;
                    if (aRating !== bRating) return bRating - aRating;

                    // Затем по количеству выполненных заказов
                    const aOrders = a.users?.completed_orders || a.completed_orders || 0;
                    const bOrders = b.users?.completed_orders || b.completed_orders || 0;
                    return bOrders - aOrders;
                });
            };
            
            // Рендерим исполнителей для текущей вкладки
            sortEmployees(employeesToShow).forEach(employee => {
                container.appendChild(createEmployeeCard(employee, currentOrderTab, order.id, order));
            });
        }
        

        /* ---------------------------
           Создание карточки исполнителя
        --------------------------- */
        function createEmployeeCard(employee, status, orderId, order = null) {
            const card = document.createElement("div");
            card.className = `employee-card-noninvite ${status}`;
            card.dataset.status = status;

            // Проверяем, заполнен ли заказ (в работе)
            const requiredSlots = order?.required_slots || 1;
            const workingEmployees = state.currentOrderResponses.filter(r => r.status === 'confirmed');
            const isFilled = workingEmployees.length >= requiredSlots || order?.status === 'in_progress';
            const canAccept = !isFilled; // Можно принимать только если заказ еще не заполнен

            // Таймер для исполнителей в работе
            const timerHtml = status === 'working' && employee.timer_start ? `
        <div class="timer">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#D32F2F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span id="timer-${employee.id}">${formatTimer(employee.timer_start)}</span>
        </div>
    ` : '';

            const employeeName = employee.users?.name || employee.users?.username || (employee.user_id ? `ID: ${employee.user_id}` : 'Неизвестно');
            const completedOrders = employee.users?.completed_orders || employee.completed_orders || 0;
            const rating = employee.users?.rating || employee.rating || 4.0;
            const avatarUrl = employee.users?.avatar_url || employee.users?.photo_url || 'img/new-desin/avatar.png';
            
            card.innerHTML = `
                <div style="background: white; border: 2px solid #1775F1; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                    <!-- Аватар с галочкой -->
                    <div style="position: relative; flex-shrink: 0;">
                        <img src="${avatarUrl}" alt="" style="width: 52px; height: 52px; border-radius: 50%; object-fit: cover;" onerror="this.src='img/new-desin/avatar.png'">
                        <div style="position: absolute; bottom: 0; right: 0; width: 18px; height: 18px; background: #1775F1; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Информация о пользователе -->
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <p style="margin: 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">${escapeHtml(employeeName)}</p>
                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #1775F1; font-family: 'Montserrat', sans-serif;">Надежный</p>
                        
                        <!-- Три квадратные кнопки -->
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <!-- Синяя кнопка с числом -->
                            <div style="width: 40px; height: 40px; background: #1775F1; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 16px; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">${completedOrders}</span>
                            </div>
                            <!-- Белая кнопка с рейтингом -->
                            <div style="width: 40px; height: 40px; background: white; border: 1px solid #E0E0E0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 16px; font-weight: 700; color: #333; font-family: 'Montserrat', sans-serif;">${rating.toFixed(1)}</span>
                            </div>
                            <!-- Фиолетовая кнопка с иконкой -->
                            <div style="width: 40px; height: 40px; background: #9333EA; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="white"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Кнопки действий в зависимости от статуса -->
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${status === 'working' ? 
                            `<div style="padding: 8px 16px; background: #e8f5e8; color: #2e7d32; border-radius: 8px; font-size: 12px; font-weight: 600; text-align: center; font-family: 'Montserrat', sans-serif;">
                                ✅ Работает
                            </div>` : ''
                        }
                        ${status === 'accepted' ? 
                            `<button class="employee-card__button" data-employee-id="${employee.id}" data-order-id="${orderId}" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                                Подтвердить
                            </button>` : ''
                        }
                        ${status === 'pending' && canAccept ?
                            `<button class="employee-card__button" data-employee-id="${employee.id}" data-order-id="${orderId}" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                                Принять
                            </button>
                            <button onclick="rejectEmployee('${employee.id}', '${orderId}')" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                                Отклонить
                            </button>` : ''
                        }
                    </div>
                </div>
            `;

            // Добавляем обработчик для кнопки
            const button = card.querySelector('.employee-card__button');
            if (button) {
                button.addEventListener('click', () => handleEmployeeAction(
                    employee.id, // это id отклика (response_id), а не user_id
                    orderId,
                    employee.status, // текущий статус в базе
                    status // отображаемый статус
                ));
            }

            // Запускаем таймер, если нужно
            if (status === 'working' && employee.timer_start) {
                startTimer(employee.id, employee.timer_start);
            }

            return card;
        }

        /* ---------------------------
           Обработка действий с исполнителем
        --------------------------- */
        async function handleEmployeeAction(employeeId, orderId, currentDbStatus, currentDisplayStatus) {
            console.log("[handleEmployeeAction] Начало:", { employeeId, orderId, currentDbStatus, currentDisplayStatus });

            let newDbStatus;
            let actionText;

            // Определяем действие по отображаемому статусу
            if (currentDisplayStatus === 'pending') {
                newDbStatus = 'accepted';
                actionText = 'принять';
            } else if (currentDisplayStatus === 'accepted') {
                newDbStatus = 'confirmed';
                actionText = 'подтвердить';
            } else if (currentDisplayStatus === 'working') {
                newDbStatus = 'completed';
                actionText = 'завершить';
            } else {
                console.warn('Неизвестный статус для обновления:', currentDisplayStatus);
                alert('Неизвестный статус исполнителя');
                return;
            }

            if (!confirm(`Вы уверены, что хотите ${actionText} этого исполнителя?`)) {
                return;
            }

            console.log("[handleEmployeeAction] Отправка запроса с newDbStatus:", newDbStatus);

            // Обновляем статус отклика
            const resp = await callApi({
                action: "updateResponseStatus",
                response_id: employeeId,
                order_id: orderId,
                status: newDbStatus
            });

            console.log("[handleEmployeeAction] Ответ сервера:", resp);

            if (resp?.success) {
                // Перезагружаем отклики
                const responsesResp = await callApi({
                    action: "getOrderResponses",
                    order_id: orderId
                });

                if (responsesResp?.success) {
                    state.currentOrderResponses = responsesResp.responses || [];
                }

                // Перезагружаем данные
                await loadUserOrders();

                // Обновляем модальное окно с новыми данными
                const order = state.orders.find(o => String(o.id) === String(orderId));
                if (order) {
                    renderEmployees(order);
                    updateOrderButtons(order);
                }

                // Показываем уведомление
                alert('Исполнитель выбран. Ожидается подтверждение от исполнителя.');
            } else {
                alert('Ошибка при обновлении статуса исполнителя: ' + (resp?.error || 'Неизвестная ошибка'));
            }
        }

        /* ---------------------------
           Отмена заказа
        --------------------------- */
        async function cancelOrder(orderId) {
            if (!confirm('Вы уверены, что хотите отменить заказ? Это действие приведет к штрафу.')) {
                return;
            }

            const resp = await callApi({
                action: "cancelOrderByLogist",
                order_id: orderId,
                logist_id: state.userId
            });

            if (resp?.success) {
                let message = 'Заказ отменен.\n';
                if (resp.penalty) {
                    message += `Штраф: ${resp.penalty}₽\n`;
                }
                if (resp.perResponder) {
                    message += `Компенсация исполнителям: ${resp.perResponder}₽ каждому`;
                }
                alert(message);
                await loadUserOrders();
                closeModal(document.getElementById('responsesModal'));
            } else {
                const errorMsg = resp?.error?.message || resp?.error || "Неизвестная ошибка";
                alert('Ошибка при отмене заказа: ' + errorMsg);
            }
        }


        /* ---------------------------
           Таймеры
        --------------------------- */
        function startTimer(employeeId, startTime) {
            const timerElement = document.getElementById(`timer-${employeeId}`);
            if (!timerElement) return;

            const start = new Date(startTime).getTime();

            function updateTimer() {
                const now = new Date().getTime();
                const elapsed = now - start;

                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));

                timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }

            // Обновляем сразу и затем каждую секунду
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        function formatTimer(startTime) {
            const start = new Date(startTime).getTime();
            const now = new Date().getTime();
            const elapsed = now - start;

            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));

            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        /* ---------------------------
           Вспомогательные функции
        --------------------------- */
        // ИЗМЕНЕНИЕ: Новая система рейтинга 0-100 с названием и цветом
        function getRatingName(rating) {
            const numRating = Number(rating || 50);
            if (numRating >= 90) return "Отличный";
            if (numRating >= 80) return "Хороший";
            if (numRating >= 70) return "Надежный";
            if (numRating >= 60) return "Средний";
            if (numRating >= 50) return "Начинающий";
            return "Низкий";
        }
        
        function getRatingColor(rating) {
            const numRating = Number(rating || 50);
            if (numRating >= 90) return "#10B981"; // green
            if (numRating >= 80) return "#3B82F6"; // blue
            if (numRating >= 70) return "#F59E0B"; // yellow
            if (numRating >= 60) return "#F97316"; // orange
            if (numRating >= 50) return "#6B7280"; // gray
            return "#EF4444"; // red
        }
        
        function renderRating(rating, showName = true) {
            const numRating = Number(rating || 50);
            const name = getRatingName(numRating);
            const color = getRatingColor(numRating);
            const nameHtml = showName ? `<span style="font-size: 14px; color: ${color}; font-weight: 600; margin-left: 8px;">${name}</span>` : '';
            return `
                <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #F9F9F9; border-radius: 8px;">
                    <span style="font-size: 24px; font-weight: 700; color: ${color};">${numRating}</span>
                    ${nameHtml}
                </div>
            `;
        }
        
        // Функция отображения характеристик (результат, пунктуальность, коммуникация)
        function renderCharacteristics(characteristics) {
            if (!characteristics || !characteristics.result || !characteristics.punctuality || !characteristics.communication) {
                return '<div style="padding: 12px; background: #F9F9F9; border-radius: 8px;"><span style="font-size: 14px; color: #999;">Нет оценок</span></div>';
            }
            const result = Number(characteristics.result || 0).toFixed(1);
            const punctuality = Number(characteristics.punctuality || 0).toFixed(1);
            const communication = Number(characteristics.communication || 0).toFixed(1);
            return `
                <div style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: #F9F9F9; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333; min-width: 120px;">Результат:</span>
                        <span style="font-size: 16px; color: #333;">${result}⭐️</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333; min-width: 120px;">Пунктуальность:</span>
                        <span style="font-size: 16px; color: #333;">${punctuality}⭐️</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333; min-width: 120px;">Коммуникация:</span>
                        <span style="font-size: 16px; color: #333;">${communication}⭐️</span>
                    </div>
                </div>
            `;
        }
        

        function getStatusText(status) {
            switch (status) {
                case 'working': return 'В работе';
                case 'review': return 'На рассмотрении';
                case 'candidate': return 'Кандидат';
                default: return status;
            }
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'недавно';
            
            // Нормализуем строку даты: если нет указания часового пояса, добавляем 'Z' (UTC)
            const normalizedDateString = normalizeUTCDate(dateString);
            if (!normalizedDateString) return 'недавно';
            
            // Парсим дату из UTC (с сервера приходит в UTC)
            const date = new Date(normalizedDateString);
            
            // Проверяем валидность даты
            if (isNaN(date.getTime())) {
                console.warn('[formatTimeAgo] Невалидная дата:', dateString, '->', normalizedDateString);
                return 'недавно';
            }
            
            // Получаем локальное время пользователя
            const now = new Date();
            
            // Вычисляем разницу в миллисекундах
            const diffMs = now.getTime() - date.getTime();
            
            // Если дата в будущем (не должно быть, но на всякий случай)
            if (diffMs < 0) {
                return 'только что';
            }
            
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);

            if (diffMins < 1) return 'только что';
            if (diffMins < 60) {
                // Склонение для минут
                const mins = diffMins;
                if (mins === 1 || (mins > 20 && mins % 10 === 1)) return `${mins} минуту назад`;
                if ((mins >= 2 && mins <= 4) || (mins > 20 && mins % 10 >= 2 && mins % 10 <= 4)) return `${mins} минуты назад`;
                return `${mins} минут назад`;
            }
            if (diffHours < 24) {
                // Склонение для часов
                const hours = diffHours;
                if (hours === 1 || (hours > 20 && hours % 10 === 1)) return `${hours} час назад`;
                if ((hours >= 2 && hours <= 4) || (hours > 20 && hours % 10 >= 2 && hours % 10 <= 4)) return `${hours} часа назад`;
                return `${hours} часов назад`;
            }
            if (diffDays < 7) {
                // Склонение для дней
                const days = diffDays;
                if (days === 1) return 'вчера';
                if (days === 2) return 'позавчера';
                if (days === 3 || days === 4) return `${days} дня назад`;
                return `${days} дней назад`;
            }
            if (diffWeeks < 4) {
                const weeks = diffWeeks;
                if (weeks === 1) return 'неделю назад';
                if (weeks >= 2 && weeks <= 4) return `${weeks} недели назад`;
                return `${weeks} недель назад`;
            }
            if (diffMonths < 12) {
                const months = diffMonths;
                if (months === 1) return 'месяц назад';
                if (months >= 2 && months <= 4) return `${months} месяца назад`;
                return `${months} месяцев назад`;
            }
            
            // Если больше года, показываем полную дату в локальном формате
            return date.toLocaleString('ru-RU', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(str = "") {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        /* ---------------------------
           Рендер баланса
        --------------------------- */
        /* ---------------------------
           Рендер истории операций в модалке Финансы
        --------------------------- */
        function renderOperationsHistoryInFinance() {
            console.log("[renderOperationsHistoryInFinance] Начало рендеринга истории операций");
            const container = document.getElementById("financeOperationsHistory");
            if (!container) {
                console.error("[renderOperationsHistoryInFinance] Контейнер не найден");
                return;
            }
            
            console.log("[renderOperationsHistoryInFinance] state.operations:", state.operations);
            console.log("[renderOperationsHistoryInFinance] Количество операций:", state.operations?.length || 0);
            
            container.innerHTML = "";

            if (!state.operations || state.operations.length === 0) {
                console.log("[renderOperationsHistoryInFinance] Нет операций, показываем пустое состояние");
                container.innerHTML = `
                    <div class="no-orders">
                        <p>У вас пока нет операций</p>
                        <p style="color: #666; font-size: 14px; margin-top: 8px;">Транзакции появятся здесь после операций с балансом</p>
                    </div>
                `;
                return;
            }

            // Фильтруем операции - показываем только пополнения и покупки подписки
            const filteredOperations = state.operations.filter(op => {
                const type = op.type || op.transaction_type || '';
                // Показываем пополнения, покупки подписки, возвраты, рефералки
                return type.includes('deposit') || type.includes('subscription') || type.includes('refund') || type.includes('referral') || type.includes('refund');
            });

            // Сортируем транзакции по дате (новые сверху)
            filteredOperations.sort((a, b) => {
                const dateA = new Date(a.created_at || a.date || 0);
                const dateB = new Date(b.created_at || b.date || 0);
                return dateB - dateA;
            });

            filteredOperations.forEach((operation, index) => {
                const operationDiv = document.createElement("div");
                operationDiv.style.cssText = "padding: 12px; border-bottom: 1px solid #E0E0E0; display: flex; justify-content: space-between; align-items: center;";
                
                const type = operation.type || operation.transaction_type || 'unknown';
                const amount = operation.amount || operation.value || 0;
                const isPositive = type.includes('deposit') || type.includes('refund') || type.includes('referral');
                
                let typeText = 'Операция';
                if (type.includes('deposit')) typeText = 'Пополнение баланса';
                else if (type.includes('subscription')) typeText = 'Покупка подписки';
                else if (type.includes('refund')) typeText = 'Возврат средств';
                else if (type.includes('referral')) typeText = 'Реферальная выплата';
                
                operationDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${escapeHtml(typeText)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">${formatTimeAgo(operation.created_at || operation.date)}</div>
                    </div>
                    <div style="font-weight: 600; font-size: 16px; color: ${isPositive ? '#059669' : '#1775F1'};">
                        ${isPositive ? '+' : ''}${amount}₽
                    </div>
                `;
                
                container.appendChild(operationDiv);
            });
        }
        
        /* ---------------------------
           Рендер истории операций
        --------------------------- */
        function renderOperationsHistory() {
            console.log("[renderOperationsHistory] Начало рендеринга истории операций");
            const modal = document.getElementById("operationsHistoryModal");
            if (!modal) {
                console.error("[renderOperationsHistory] Модальное окно не найдено");
                return;
            }

            const container = modal.querySelector(".operations-history");
            if (!container) {
                console.error("[renderOperationsHistory] Контейнер не найден");
                return;
            }
            
            console.log("[renderOperationsHistory] state.operations:", state.operations);
            console.log("[renderOperationsHistory] Количество операций:", state.operations?.length || 0);
            
            container.innerHTML = "";

            if (!state.operations || state.operations.length === 0) {
                console.log("[renderOperationsHistory] Нет операций, показываем пустое состояние");
                container.innerHTML = `
                    <div class="no-orders">
                        <p>У вас пока нет операций</p>
                        <p style="color: #666; font-size: 14px; margin-top: 8px;">Транзакции появятся здесь после операций с балансом</p>
                    </div>
                `;
                return;
            }

            // Сортируем транзакции по дате (новые сверху)
            const sortedOperations = [...state.operations].sort((a, b) => {
                const normalizedA = normalizeUTCDate(a.created_at);
                const normalizedB = normalizeUTCDate(b.created_at);
                const dateA = new Date(normalizedA || a.created_at || 0).getTime();
                const dateB = new Date(normalizedB || b.created_at || 0).getTime();
                return dateB - dateA;
            });

            sortedOperations.forEach((transaction, index) => {
                // Определяем, является ли транзакция расходом
                // expense, hold, payout_reserved, penalty - это расходы
                // income - это доход
                const isExpense = transaction.type === 'expense' || 
                                  transaction.type === 'hold' || 
                                  transaction.type === 'payout_reserved' || 
                                  transaction.type === 'penalty' ||
                                  Number(transaction.amount || 0) < 0;
                
                const amount = Math.abs(Number(transaction.amount || 0));
                const sign = isExpense ? '-' : '+';
                
                const div = document.createElement("div");
                div.className = `operation-item operation-item--${isExpense ? 'expense' : 'income'}`;
                
                const normalizedDate = transaction.created_at ? normalizeUTCDate(transaction.created_at) : null;
                const date = normalizedDate ? new Date(normalizedDate).toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                }) : '';
                
                div.innerHTML = `
                    <div class="operation-item__icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 1V23M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="${isExpense ? '#FF5F57' : '#059669'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="operation-item__info">
                        <p class="operation-item__title">${escapeHtml(transaction.description || 'Операция')}</p>
                        <p class="operation-item__date">${date}</p>
                    </div>
                    <p class="operation-item__amount operation-item__amount--${isExpense ? 'expense' : 'income'}">${sign}${amount}₽</p>
                `;
                container.appendChild(div);
                
                // Добавляем разделитель между операциями (кроме последней)
                if (index < sortedOperations.length - 1) {
                    const separator = document.createElement("div");
                    separator.className = "payment-line";
                    container.appendChild(separator);
                }
            });
            
            console.log("[renderOperationsHistory] История операций отрендерена, операций:", sortedOperations.length);
        }
        
        // Функция для обновления имени логиста во всех местах
        function updateLogistName(name) {
            if (!name) {
                console.warn("[updateLogistName] Имя не предоставлено");
                return;
            }
            console.log("[updateLogistName] Обновление имени на:", name);
            
            // Обновляем все элементы с именем логиста по ID
            const nameElements = [
                document.getElementById('logistName'),
                document.getElementById('logistProfileName'),
                document.getElementById('logistCreateOrderName')
            ].filter(el => el); // Убираем null элементы
            
            console.log("[updateLogistName] Найдено элементов:", nameElements.length);
            nameElements.forEach((el, index) => {
                console.log(`[updateLogistName] Обновление элемента ${index}:`, el, 'текст был:', el.textContent, '-> будет:', name);
                el.textContent = name;
            });
            
            // Также обновляем state для использования в других местах
            state.userName = name;
        }
        
        // ИЗМЕНЕНИЕ: Функция отображения рейтинга и характеристик в профиле логиста
        function renderLogistRating() {
            const ratingDisplay = document.getElementById("logistRatingDisplay");
            if (!ratingDisplay) {
                console.warn("[renderLogistRating] Блок рейтинга не найден");
                return;
            }
            
            const rating = Number(state.profile.rating || 50);
            const characteristics = state.profile.characteristics || null;
            
            ratingDisplay.innerHTML = `
                ${renderRating(rating, true)}
                ${characteristics ? renderCharacteristics(characteristics) : '<div style="padding: 12px; background: #F9F9F9; border-radius: 8px;"><span style="font-size: 14px; color: #999;">Нет оценок</span></div>'}
            `;
        }
        
        function renderBalance() {
            const modal = document.getElementById("balanceAndPayoutsModal");
            if (!modal) return;
            const available = modal.querySelector("#modalBalance");
            if (available) available.textContent = state.balance.available;
        }
        
        /* ---------------------------
           Обновление видимости требований
        --------------------------- */
        function updateRequirementsVisibility(subscriptionTier) {
            const requirementsGroup = document.getElementById('requirementsGroup');
            const additionalRequirementsGroup = document.getElementById('additionalRequirementsGroup');
            
            // Требования доступны только для платных подписок (logist_light и выше)
            const hasRequirementsAccess = subscriptionTier && (
                subscriptionTier === 'logist_light' || 
                subscriptionTier === 'logist_business'
            );
            
            if (requirementsGroup) {
                requirementsGroup.style.display = hasRequirementsAccess ? 'block' : 'none';
            }
            if (additionalRequirementsGroup) {
                additionalRequirementsGroup.style.display = hasRequirementsAccess ? 'block' : 'none';
            }
        }

        /* ---------------------------
           Модальные окна
        --------------------------- */
        function openModal(modal) {
            if (modal) {
                modal.classList.add("modal-open");
                modal.style.display = "flex";
            }
        }

        function closeModal(modal) {
            if (modal) {
                modal.classList.remove("modal-open");
                modal.style.display = "none";
            }
        }

        function initModals() {
            // Закрытие по overlay и кнопке закрытия
            document.querySelectorAll(".vacancies-modal").forEach(modal => {
                const overlay = modal.querySelector(".vacancies-modal__overlay");
                const closeBtn = modal.querySelector(".vacancies-modal__close");

                if (overlay) overlay.addEventListener("click", () => closeModal(modal));
                if (closeBtn) closeBtn.addEventListener("click", () => closeModal(modal));
            });

            // Открытие модальных окон профиля
            const modalMap = [
                { btnId: 'balanceAndPayouts', modalId: 'balanceAndPayoutsModal' },
                { btnId: 'operationsHistory', modalId: 'operationsHistoryModal' },
                { btnId: 'supportSection', modalId: 'supportSectionModal' }
            ];

            modalMap.forEach(item => {
                const btn = document.getElementById(item.btnId);
                const modal = document.getElementById(item.modalId);
                if (!btn || !modal) return;

                btn.addEventListener("click", async () => {
                    if (item.modalId === 'operationsHistoryModal') {
                        // Перезагружаем баланс и операции перед открытием
                        await loadUserBalance();
                        renderOperationsHistory();
                    }
                    if (item.modalId === 'balanceAndPayoutsModal') {
                        // Перезагружаем баланс и операции перед открытием
                        await loadUserBalance();
                        renderBalance();
                        renderOperationsHistoryInFinance();
                    }
                    openModal(modal);
                });
            });
            
            // Обработчики для кнопок нижнего меню
            const bottomNavFinance = document.getElementById("bottomNavFinance");
            const bottomNavFinanceProfile = document.getElementById("bottomNavFinanceProfile");
            const bottomNavFinanceCreate = document.getElementById("bottomNavFinanceCreate");
            const bottomNavSupport = document.getElementById("bottomNavSupport");
            const bottomNavSupportProfile = document.getElementById("bottomNavSupportProfile");
            const bottomNavSupportCreate = document.getElementById("bottomNavSupportCreate");
            
            if (bottomNavFinance || bottomNavFinanceProfile || bottomNavFinanceCreate) {
                const handler = async () => {
                    await loadUserBalance();
                    renderBalance();
                    renderOperationsHistoryInFinance();
                    const modal = document.getElementById("balanceAndPayoutsModal");
                    openModal(modal);
                };
                if (bottomNavFinance) bottomNavFinance.addEventListener("click", handler);
                if (bottomNavFinanceProfile) bottomNavFinanceProfile.addEventListener("click", handler);
                if (bottomNavFinanceCreate) bottomNavFinanceCreate.addEventListener("click", handler);
            }
            
            if (bottomNavSupport || bottomNavSupportProfile || bottomNavSupportCreate) {
                const handler = () => {
                    const modal = document.getElementById("supportSectionModal");
                    openModal(modal);
                };
                if (bottomNavSupport) bottomNavSupport.addEventListener("click", handler);
                if (bottomNavSupportProfile) bottomNavSupportProfile.addEventListener("click", handler);
                if (bottomNavSupportCreate) bottomNavSupportCreate.addEventListener("click", handler);
            }
        }

        /* ---------------------------
           Навигация по страницам
        --------------------------- */
        function showPage(pageId) {
            document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
            document.querySelectorAll(".bottom-nav__icon").forEach(icon => icon.classList.remove("active"));

            const page = document.getElementById(pageId);
            if (page) page.classList.add("active");

            // Обновляем активную иконку в навигации на всех страницах
            document.querySelectorAll(`.bottom-nav__icon[onclick*="${pageId}"]`).forEach(icon => {
                icon.classList.add("active");
            });
        }

        /* ---------------------------
           Создание заказа
        --------------------------- */
        function initOrderForm() {
            const orderForm = document.getElementById("orderForm");
            if (orderForm) {
                orderForm.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    if (!state.userId) {
                        alert("Не удалось определить пользователя. Попробуйте перезагрузить страницу.");
                        return;
                    }

                    // Формируем фильтры
                    const filters = {};
                    if (document.getElementById("onlyWomen").checked) filters.gender = "female";
                    if (document.getElementById("onlyMen").checked) filters.gender = "male";
                    if (document.getElementById("minRating").checked) filters.rating_min = 4;

                    // Формируем дату и время начала
                    const dateValue = document.getElementById("date").value;
                    const timeValue = document.getElementById("start_time").value;
                    const startTime = dateValue && timeValue ? `${dateValue}T${timeValue}:00` : null;

                    // Проверка минимального времени работы (4 часа)
                    const durationHours = parseInt(document.getElementById("duration").value) || 1;
                    if (durationHours < 4) {
                        alert("Минимальное время работы - 4 часа");
                        return;
                    }

                    // ИЗМЕНЕНИЕ: Логист ничего не платит при создании заказа
                    // Проверка баланса <= 0 для блокировки работы остается (штрафы)
                    const currentBalance = Number(state.balance.available || 0);
                    if (currentBalance < 0) {
                        alert("Баланс отрицательный. Пополните баланс для создания заказов.");
                        return;
                    }

                    const orderData = {
                        action: "createOrder",
                        created_by: state.userId,
                        title: document.getElementById("title").value.trim(),
                        description: document.getElementById("description").value.trim(),
                        location: document.getElementById("location").value.trim(),
                        metro_station: document.getElementById("metro_station").value.trim(),
                        start_time: startTime,
                        required_slots: parseInt(document.getElementById("people").value) || 1,
                        duration_hours: durationHours,
                        wage_per_hour: parseFloat(document.getElementById("rate").value) || 0,
                        deposit_amount: 0, // Депозиты отменены
                        premium: document.getElementById("premium").checked || false,
                        filters: filters,
                        extra: {}
                    };

                    try {
                        const resp = await callApi(orderData);
                        if (resp?.success) {
                            alert("Заказ успешно создан!");
                            orderForm.reset();
                            // Немедленно обновляем данные
                            await loadUserOrders();
                            await loadUserBalance();
                            showPage('page-orders');
                        } else {
                            alert("Ошибка создания заказа: " + (resp?.error?.message || resp?.error || "Неизвестная ошибка"));
                        }
                    } catch (err) {
                        console.error("[createOrder] Ошибка:", err);
                        alert("Ошибка при создании заказа");
                    }
                });
            }
        }

        /* ---------------------------
           Инициализация приложения
        --------------------------- */
        // Инициализация фильтрации заказов по вкладкам
        function initOrderFiltering() {
            const tabs = document.querySelectorAll('[data-order-filter]');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Обновляем активную вкладку
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Обновляем фильтр в state
                    state.currentOrderFilter = tab.dataset.orderFilter;
                    
                    // Перерисовываем заказы
                    renderOrders();
                });
            });
        }

        // --- МОДАЛКА ПОДПИСОК ---
        // Данные подписок для логистов
        const subscriptionData = [
            {
                id: 'logist_basic',
                name: 'Стартовый',
                price: '0',
                period: 'руб/мес',
                features: [
                    'До 10 заказов в день',
                    'Базовый трекинг',
                    'Общая статистика',
                    'Поддержка по email'
                ],
                popular: false
            },
            {
                id: 'logist_pro',
                name: 'PRO',
                price: '799',
                period: 'руб/мес',
                features: [
                    'До 50 заказов в день',
                    'Расширенный трекинг',
                    'Приоритетная поддержка',
                    'API доступ',
                    'Кастомные маршруты',
                    'Аналитика эффективности'
                ],
                popular: true
            },
            {
                id: 'logist_enterprise',
                name: 'Предприятие',
                price: '1499',
                period: 'руб/мес',
                features: [
                    'Неограниченное количество заказов',
                    'Полный API доступ',
                    'Персональный аккаунт-менеджер',
                    'Кастомные интеграции',
                    'Расширенная аналитика',
                    'Высший приоритет поддержки'
                ],
                popular: false
            }
        ];

        let selectedSubscription = null;

        // Получаем элементы модалки подписок
        const subscriptionSheetOverlay = document.getElementById('subscriptionSheetOverlay');
        const subscriptionBottomSheet = document.getElementById('subscriptionBottomSheet');
        const subscriptionsList = document.getElementById('subscriptionsList');
        const confirmButton = document.getElementById('confirmButton');

        // Функция для показа плашки с подписками
        function showSubscriptionSheet() {
            if (subscriptionSheetOverlay) {
                subscriptionSheetOverlay.style.display = 'flex';
                
                setTimeout(() => {
                    if (subscriptionBottomSheet) {
                        subscriptionBottomSheet.classList.add('bottom-sheet--active');
                    }
                }, 10);
                
                document.body.style.overflow = 'hidden';
                renderSubscriptions();
            }
        }

        // Функция для скрытия плашки
        function hideSubscriptionSheet() {
            if (subscriptionBottomSheet) {
                subscriptionBottomSheet.classList.remove('bottom-sheet--active');
            }
            setTimeout(() => {
                if (subscriptionSheetOverlay) {
                    subscriptionSheetOverlay.style.display = 'none';
                }
                document.body.style.overflow = '';
            }, 300);
        }

        // Функция рендера подписок
        function renderSubscriptions() {
            if (!subscriptionsList) return;
            subscriptionsList.innerHTML = subscriptionData.map(sub => {
                const isSelected = selectedSubscription === sub.id;
                return `
                    <div class="subscription-card-new ${isSelected ? 'selected' : ''}" 
                         onclick="selectSubscription('${sub.id}')"
                         style="background: white; border-radius: 12px; padding: 16px; border: ${isSelected ? '2px solid #1775F1' : '1px solid #E0E0E0'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">${sub.name}</h3>
                                <div style="font-size: 16px; font-weight: 600; color: #333; font-family: 'Montserrat', sans-serif;">${sub.price}${sub.period === 'руб/мес' ? 'Р / мес' : sub.period}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${sub.features.slice(0, 4).map(feature => `
                                    <div style="font-size: 14px; color: #666; font-family: 'Montserrat', sans-serif;">${feature}</div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="margin-left: 16px; flex-shrink: 0;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; border: ${isSelected ? '2px solid #1775F1' : '2px solid #E0E0E0'}; background: ${isSelected ? '#1775F1' : 'white'}; display: flex; align-items: center; justify-content: center;">
                                ${isSelected ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: white;"></div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Функция выбора подписки
        function selectSubscription(subscriptionId) {
            selectedSubscription = subscriptionId;
            renderSubscriptions();
            if (confirmButton) {
                confirmButton.disabled = false;
                
                // Обновляем текст кнопки подтверждения
                const selectedSub = subscriptionData.find(sub => sub.id === subscriptionId);
                if (selectedSub) {
                    confirmButton.textContent = `Выбрать ${selectedSub.name} - ${selectedSub.price}${selectedSub.period === 'руб/мес' ? '₽/мес' : selectedSub.period}`;
                }
            }
        }

        // Функция подтверждения выбора
        function confirmSubscription() {
            if (!selectedSubscription) return;
            
            const selectedSub = subscriptionData.find(sub => sub.id === selectedSubscription);
            if (selectedSub) {
                alert(`🐱 Мяу! Вы выбрали подписку "${selectedSub.name}" для логиста!\nСтоимость: ${selectedSub.price}${selectedSub.period === 'руб/мес' ? '₽/мес' : selectedSub.period}`);
                
                // Здесь обычно отправляем данные на сервер
                console.log(`Выбрана подписка: ${selectedSub.name} для логиста`);
                
                hideSubscriptionSheet();
            }
        }

        // Обработчики событий для модалки подписок
        if (subscriptionSheetOverlay) {
            subscriptionSheetOverlay.addEventListener('click', function(event) {
                if (event.target === subscriptionSheetOverlay) {
                    hideSubscriptionSheet();
                }
            });
        }

        // Закрытие по клавише Esc
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && subscriptionSheetOverlay && subscriptionSheetOverlay.style.display === 'flex') {
                hideSubscriptionSheet();
            }
        });

        // Swipe для закрытия
        if (subscriptionBottomSheet) {
            let startY = 0;
            let currentY = 0;

            subscriptionBottomSheet.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });

            subscriptionBottomSheet.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                
                if (diff > 0) {
                    subscriptionBottomSheet.style.transform = `translateY(${diff}px)`;
                }
            });

            subscriptionBottomSheet.addEventListener('touchend', () => {
                const diff = currentY - startY;
                if (diff > 100) {
                    hideSubscriptionSheet();
                } else {
                    subscriptionBottomSheet.style.transform = 'translateY(0)';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initUser();
            initModals();
            initOrderForm();
            initOrderFiltering();
            
            // Обновляем имя после инициализации, если оно уже загружено
            // Используем небольшую задержку, чтобы убедиться, что данные загрузились
            setTimeout(() => {
                if (state.userName) {
                    console.log("[DOMContentLoaded] Обновление имени после инициализации:", state.userName);
                    updateLogistName(state.userName);
                }
            }, 500);

            // Устанавливаем минимальную дату как сегодня
            const dateInput = document.getElementById('date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = today;
            }
            
            // Инициализация формы регистрации
            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    registerUser();
                });
            }
            
            // Закрытие модального окна регистрации
            const registrationModal = document.getElementById('registrationModal');
            if (registrationModal) {
                const overlay = registrationModal.querySelector('.vacancies-modal__overlay');
                const closeBtn = registrationModal.querySelector('.vacancies-modal__close');
                
                if (overlay) {
                    overlay.addEventListener('click', hideRegistrationModal);
                }
                if (closeBtn) {
                    closeBtn.addEventListener('click', hideRegistrationModal);
                }
            }
            
            // ИЗМЕНЕНИЕ: Инициализация модалки оценки при загрузке страницы
            // Инициализация слайдеров оценки
            const resultSlider = document.getElementById("ratingResult");
            const punctualitySlider = document.getElementById("ratingPunctuality");
            const communicationSlider = document.getElementById("ratingCommunication");
            
            if (resultSlider) {
                resultSlider.addEventListener("input", function() {
                    const valueDisplay = document.getElementById("ratingResultValue");
                    if (valueDisplay) {
                        valueDisplay.textContent = this.value;
                    }
                });
            }
            
            if (punctualitySlider) {
                punctualitySlider.addEventListener("input", function() {
                    const valueDisplay = document.getElementById("ratingPunctualityValue");
                    if (valueDisplay) {
                        valueDisplay.textContent = this.value;
                    }
                });
            }
            
            if (communicationSlider) {
                communicationSlider.addEventListener("input", function() {
                    const valueDisplay = document.getElementById("ratingCommunicationValue");
                    if (valueDisplay) {
                        valueDisplay.textContent = this.value;
                    }
                });
            }
            
            // Кнопка отправки оценки
            const submitBtn = document.getElementById("submitRatingBtn");
            if (submitBtn) {
                submitBtn.addEventListener("click", submitRating);
            }
            
            // Запрещаем закрытие модалки по клику на overlay
            const ratingModal = document.getElementById("ratingModal");
            if (ratingModal) {
                const overlay = ratingModal.querySelector(".vacancies-modal__overlay");
                if (overlay) {
                    overlay.addEventListener("click", function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        // Модалка обязательная, нельзя закрыть
                    });
                }
            }
        });
        
        /* ---------------------------
           Регистрация логиста
        --------------------------- */
        
        // Показать модальное окно регистрации (с возможностью предзаполнения данных)
        function showRegistrationModal(userData = null) {
            console.log("[showRegistrationModal] Показ формы регистрации, userData:", userData);
            
            const modal = document.getElementById('registrationModal');
            if (!modal) {
                console.error("[showRegistrationModal] Модальное окно не найдено!");
                return;
            }
            
            console.log("[showRegistrationModal] Модальное окно найдено:", modal);
            
            // Заполняем Telegram ID
            const telegramIdInput = document.getElementById('regTelegramId');
            if (telegramIdInput) {
                telegramIdInput.value = state.userId;
                console.log("[showRegistrationModal] Telegram ID заполнен:", state.userId);
            } else {
                console.error("[showRegistrationModal] Поле Telegram ID не найдено!");
            }
            
            // Автоматически устанавливаем роль и подписку
            const roleInput = document.getElementById('regRole');
            const subscriptionInput = document.getElementById('regSubscriptionTier');
            if (roleInput) {
                roleInput.value = 'logistic'; // Всегда логист для logist.html
            }
            if (subscriptionInput) {
                subscriptionInput.value = 'logist_start'; // Всегда бесплатная подписка для логиста
            }
            
            // Если есть данные пользователя, заполняем только имя пользователя
            if (userData) {
                console.log("[showRegistrationModal] Заполнение формы данными пользователя:", userData);
                const usernameInput = document.getElementById('regUsername');
                
                if (usernameInput && userData.username) {
                    usernameInput.value = userData.username;
                }
                // Роль и подписка всегда устанавливаются автоматически
            }
            
            // Показываем модальное окно с анимацией
            modal.classList.add("modal-open");
            modal.style.display = 'flex';
            
            console.log("[showRegistrationModal] ✅ Модальное окно показано с анимацией");
        }
        
        // Скрыть модальное окно регистрации
        function hideRegistrationModal() {
            console.log("[hideRegistrationModal] Скрытие формы регистрации");
            const modal = document.getElementById('registrationModal');
            if (modal) {
                modal.classList.remove("modal-open");
                modal.style.display = 'none';
            }
        }
        
        // Делаем функцию глобальной для onclick
        window.hideRegistrationModal = hideRegistrationModal;
        
        // Регистрация логиста
        async function registerUser() {
            const telegramId = document.getElementById('regTelegramId')?.value;
            const username = document.getElementById('regUsername')?.value;
            // Роль и подписка автоматически устанавливаются
            const role = 'logistic'; // Всегда логист для logist.html
            const subscriptionTier = 'logist_start'; // Всегда бесплатная подписка для логиста
            
            console.log("[registerUser] Регистрация с параметрами:", {
                telegramId,
                username,
                role,
                subscriptionTier
            });
            
            if (!telegramId) {
                alert('Telegram ID обязателен');
                return;
            }
            
            if (!username || username.trim() === '') {
                alert('Имя пользователя обязательно');
                return;
            }
            
            const resp = await callApi({
                action: 'registerUser',
                telegram_id: telegramId,
                username: username.trim(),
                role: role,
                subscription_tier: subscriptionTier
            });
            
            if (resp?.success) {
                alert('Регистрация успешна!');
                hideRegistrationModal();
                // Перезагружаем данные пользователя
                await loadUserBalance();
                await loadUserOrders();
            } else {
                alert('Ошибка регистрации: ' + (resp?.error || 'Неизвестная ошибка'));
            }
        }
        
    </script>

    <!-- Модалка выплат исполнителям (money-send.html) -->
    <div class="bottom-sheet-overlay" id="paymentSheetOverlay">
        <div class="bottom-sheet" id="paymentBottomSheet">
            <div class="bottom-sheet__handle"></div>
            <div class="payment-header">
                <h2 class="payment-title">Выплаты исполнителям</h2>
                <p class="payment-subtitle">Переведите средства по реквизитам ниже</p>
            </div>
            <div class="order-info">
                <div class="order-amount">
                    <div class="total-label">Общая сумма заказа</div>
                    <div class="total-amount" id="paymentTotalAmount">15 000 ₽</div>
                </div>
                <div class="order-details">
                    <div class="detail-item">
                        <span class="detail-label">Номер заказа</span>
                        <span class="detail-value" id="paymentOrderId">#123123</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Статус</span>
                        <span class="detail-value status-completed">Завершен</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Дата выполнения</span>
                        <span class="detail-value" id="paymentCompletionDate">25.12.2024</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Исполнителей</span>
                        <span class="detail-value" id="paymentExecutorsCount">3 человека</span>
                    </div>
                </div>
            </div>
            <div class="executors-section">
                <h3 class="section-title">Исполнители и реквизиты</h3>
                <div class="executors-list" id="paymentExecutorsList"></div>
            </div>
            <div class="payment-actions">
                <button class="btn btn--secondary" onclick="remindLater()">
                    Напомнить позже
                </button>
                <button class="btn btn--primary" onclick="confirmPayment()">
                    Все переводы выполнены
                </button>
            </div>
        </div>
    </div>

    <!-- Модалка предупреждения о лимите (push-logist.html) -->
    <div class="bottom-sheet-overlay" id="limitSheetOverlay">
        <div class="bottom-sheet" id="limitBottomSheet">
            <div class="bottom-sheet__handle"></div>
            <div class="bottom-sheet__icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 9V11M12 15H12.01M5.07183 19H18.9282C20.4678 19 21.4301 17.3333 20.6603 16L13.7321 4C12.9623 2.66667 11.0377 2.66667 10.2679 4L3.33975 16C2.56995 17.3333 3.53223 19 5.07183 19Z" stroke="#FF9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="bottom-sheet__header">
                <h2>Лимит заказов достигнут! ⚠️</h2>
            </div>
            <div class="bottom-sheet__content">
                <div class="limit-warning">
                    <p><strong>Вы достигли максимального количества заказов на вашем текущем тарифе.</strong></p>
                    <div class="warning-details">
                        <div class="warning-item">
                            <span class="warning-badge">❗</span>
                            <span>Сегодня: <strong id="limitCurrentOrders">50/50 заказов</strong></span>
                        </div>
                        <div class="warning-item">
                            <span class="warning-badge">⏰</span>
                            <span>До повышения тарифа: <strong id="limitTimeLeft">23 часа 59 минут</strong></span>
                        </div>
                    </div>
                    <div class="critical-warning">
                        <span class="critical-icon">🚨</span>
                        <p>Если вы не повысите тариф до <strong id="limitDeadline">завтрашнего дня, 23:59</strong>, все новые заказы будут автоматически <strong>удалены</strong>!</p>
                    </div>
                </div>
            </div>
            <div class="bottom-sheet__actions">
                <button class="btn btn--secondary" id="remindLaterBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Напомнить позже
                </button>
                <button class="btn btn--primary" id="upgradeTariffBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 7H19M19 7V13M19 7L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Повысить тариф
                </button>
            </div>
        </div>
    </div>

    <!-- Модалка выбора подписки (podpiski.html) -->
    <!-- Модалка выбора подписки (podpiski.html) -->
    <div class="bottom-sheet-overlay" id="subscriptionSheetOverlay">
        <div class="bottom-sheet" id="subscriptionBottomSheet">
            <div class="modal-content-wrapper">
                <!-- Ручка для свайпа -->
                <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px; margin: 12px auto 0;"></div>
                
                <!-- Header -->
                <div style="position: relative; margin-top: 16px; margin-bottom: 20px;">
                    <div class="vacancies-modal__close" data-close="true" style="position: absolute; top: 0; right: 0; font-size: 24px; cursor: pointer; color: #666;">&times;</div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600; text-align: center; color: #333; font-family: 'Montserrat', sans-serif;">Выберите подписку</h2>
                    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666; text-align: center; font-family: 'Montserrat', sans-serif;">Просмотрите чат заказов</p>
                </div>
                
                <!-- Список подписок -->
                <div class="subscriptions-container" style="padding: 0 20px 20px;">
                    <div class="subscriptions-list" id="subscriptionsList" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <!-- Подписки будут добавлены динамически -->
                    </div>
                </div>
                
                <!-- Кнопка "Оплатить" -->
                <button class="confirm-button" id="confirmButton" disabled onclick="confirmSubscription()" style="width: calc(100% - 40px); margin: 0 20px 20px; padding: 16px; background: #059669; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif;">
                    Оплатить
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Стили для модалки выплат */
        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
        }

        .bottom-sheet {
            background: #ffffff;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-height: 90vh;
            overflow-y: auto;
        }

        .bottom-sheet__handle {
            width: 40px;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin: 16px auto;
        }

        .payment-header {
            text-align: center;
            padding: 0 24px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .payment-title {
            margin: 0 0 8px 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .payment-subtitle {
            margin: 0;
            font-size: 1rem;
            color: #666;
        }

        .order-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 24px;
        }

        .order-amount {
            text-align: center;
        }

        .total-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 4px;
        }

        .total-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4CAF50;
            margin: 0;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }

        .executors-section {
            padding: 0 24px 24px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 20px 0;
            color: #333;
        }

        .executors-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .executor-card {
            border: 2px solid #f0f0f0;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .executor-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .executor-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: #fafafa;
            border-bottom: 1px solid #f0f0f0;
        }

        .executor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .executor-info {
            flex: 1;
        }

        .executor-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #333;
        }

        .executor-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4CAF50;
        }

        .executor-requisites {
            padding: 0 20px 20px;
        }

        .requisites-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 16px 0 12px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .requisites-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .requisite-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .requisite-info {
            flex: 1;
        }

        .requisite-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 2px;
        }

        .requisite-value {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .copy-button {
            background: none;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .copy-button:hover {
            background: #667eea;
            color: white;
        }

        .payment-actions {
            padding: 20px 24px;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
            border-radius: 0 0 24px 24px;
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn--secondary {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
        }

        .btn--secondary:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .btn--primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn--primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .bottom-sheet--active {
            transform: translateY(0);
        }

        .status-completed {
            color: #4CAF50;
            font-weight: 600;
        }

        /* Стили для модалки предупреждения о лимите */
        .bottom-sheet__icon {
            text-align: center;
            padding: 10px 0 0;
        }

        .bottom-sheet__header {
            padding: 10px 24px 16px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .bottom-sheet__header h2 {
            margin: 0;
            font-size: 1.4rem;
            color: #d32f2f;
            font-weight: 700;
        }

        .bottom-sheet__content {
            padding: 20px 24px;
        }

        .limit-warning {
            text-align: center;
        }

        .limit-warning p {
            margin: 0 0 20px;
            font-size: 1.1rem;
            line-height: 1.5;
            color: #333;
        }

        .warning-details {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            text-align: left;
        }

        .warning-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            font-size: 1rem;
        }

        .warning-badge {
            font-size: 1.2rem;
        }

        .critical-warning {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            text-align: left;
        }

        .critical-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .critical-warning p {
            margin: 0;
            color: #d32f2f;
            font-size: 1rem;
            line-height: 1.4;
        }

        .bottom-sheet__actions {
            padding: 20px 24px 30px;
            display: flex;
            gap: 12px;
            border-top: 1px solid #f0f0f0;
            background-color: #fafafa;
        }


        @media (max-width: 480px) {
            .bottom-sheet {
                border-radius: 24px 24px 0 0;
            }
            .order-details {
                grid-template-columns: 1fr;
            }
            .payment-actions {
                flex-direction: column;
            }
            .executor-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            .bottom-sheet__actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .subscription-card {
                padding: 16px;
            }
            .subscription-price {
                font-size: 1.7rem;
            }
        }
    </style>

    <script>
        // Функции для модалки выплат
        const paymentSheetOverlay = document.getElementById('paymentSheetOverlay');
        const paymentBottomSheet = document.getElementById('paymentBottomSheet');
        const paymentExecutorsList = document.getElementById('paymentExecutorsList');

        function showPaymentSheet(orderData) {
            if (paymentSheetOverlay && paymentBottomSheet) {
                if (orderData) {
                    if (document.getElementById('paymentTotalAmount')) {
                        document.getElementById('paymentTotalAmount').textContent = `${orderData.totalAmount.toLocaleString()} ₽`;
                    }
                    if (document.getElementById('paymentOrderId')) {
                        document.getElementById('paymentOrderId').textContent = `#${orderData.orderId}`;
                    }
                    if (document.getElementById('paymentCompletionDate')) {
                        document.getElementById('paymentCompletionDate').textContent = orderData.completionDate;
                    }
                    if (document.getElementById('paymentExecutorsCount')) {
                        document.getElementById('paymentExecutorsCount').textContent = `${orderData.executors.length} ${orderData.executors.length === 1 ? 'человек' : 'человека'}`;
                    }
                    if (paymentExecutorsList && orderData.executors) {
                        paymentExecutorsList.innerHTML = orderData.executors.map(exec => `
                            <div class="executor-card">
                                <div class="executor-header">
                                    <div class="executor-avatar">${exec.avatar || exec.name.charAt(0)}</div>
                                    <div class="executor-info">
                                        <div class="executor-name">${exec.name}</div>
                                        <div class="executor-amount">${exec.amount.toLocaleString()} ₽</div>
                                    </div>
                                </div>
                                <div class="executor-requisites">
                                    <div class="requisites-title">Реквизиты для перевода:</div>
                                    <div class="requisites-list">
                                        ${exec.requisites.map(req => `
                                            <div class="requisite-item">
                                                <div class="requisite-info">
                                                    <div class="requisite-label">${req.bank || 'По номеру телефона'}</div>
                                                    <div class="requisite-value">${req.value}</div>
                                                </div>
                                                <button class="copy-button" onclick="copyToClipboard('${req.value}', this)">
                                                    Копировать
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                paymentSheetOverlay.style.display = 'flex';
                setTimeout(() => {
                    paymentBottomSheet.classList.add('bottom-sheet--active');
                }, 10);
                document.body.style.overflow = 'hidden';
            }
        }

        function hidePaymentSheet() {
            if (paymentBottomSheet) {
                paymentBottomSheet.classList.remove('bottom-sheet--active');
                setTimeout(() => {
                    if (paymentSheetOverlay) {
                        paymentSheetOverlay.style.display = 'none';
                    }
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Скопировано!';
                button.style.background = '#4CAF50';
                button.style.color = 'white';
                button.style.borderColor = '#4CAF50';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                    button.style.color = '';
                    button.style.borderColor = '';
                }, 2000);
            }).catch(err => {
                console.error('Ошибка копирования: ', err);
                alert('Не удалось скопировать текст');
            });
        }

        function remindLater() {
            alert('Напомним о выплатах через 4 часа ⏰');
            hidePaymentSheet();
        }

        function confirmPayment() {
            if (confirm('Вы уверены, что выполнили все переводы всем исполнителям?')) {
                alert('✅ Отлично! Все переводы подтверждены. Исполнители уведомлены.');
                hidePaymentSheet();
                console.log('Все переводы подтверждены логистом');
            }
        }

        if (paymentSheetOverlay) {
            paymentSheetOverlay.addEventListener('click', function(event) {
                if (event.target === paymentSheetOverlay) {
                    hidePaymentSheet();
                }
            });
        }

        // Функции для модалки предупреждения о лимите
        const limitSheetOverlay = document.getElementById('limitSheetOverlay');
        const limitBottomSheet = document.getElementById('limitBottomSheet');
        const remindLaterBtn = document.getElementById('remindLaterBtn');
        const upgradeTariffBtn = document.getElementById('upgradeTariffBtn');

        function showLimitWarning(limitData) {
            if (limitSheetOverlay && limitBottomSheet) {
                if (limitData) {
                    if (document.getElementById('limitCurrentOrders')) {
                        document.getElementById('limitCurrentOrders').textContent = `${limitData.current}/${limitData.limit} заказов`;
                    }
                    if (document.getElementById('limitTimeLeft')) {
                        document.getElementById('limitTimeLeft').textContent = limitData.timeLeft;
                    }
                    if (document.getElementById('limitDeadline')) {
                        document.getElementById('limitDeadline').textContent = limitData.deadline;
                    }
                }
                limitSheetOverlay.style.display = 'flex';
                setTimeout(() => {
                    limitBottomSheet.classList.add('bottom-sheet--active');
                }, 10);
                document.body.style.overflow = 'hidden';
                localStorage.setItem('limitWarningShown', new Date().toISOString());
            }
        }

        function hideLimitWarning() {
            if (limitBottomSheet) {
                limitBottomSheet.classList.remove('bottom-sheet--active');
                setTimeout(() => {
                    if (limitSheetOverlay) {
                        limitSheetOverlay.style.display = 'none';
                    }
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        if (limitSheetOverlay) {
            limitSheetOverlay.addEventListener('click', function(event) {
                if (event.target === limitSheetOverlay) {
                    hideLimitWarning();
                }
            });
        }

        if (remindLaterBtn) {
            remindLaterBtn.addEventListener('click', function() {
                const remindTime = new Date();
                remindTime.setHours(remindTime.getHours() + 4);
                localStorage.setItem('remindLimitAfter', remindTime.toISOString());
                alert('Напомним через 4 часа');
                hideLimitWarning();
            });
        }

        if (upgradeTariffBtn) {
            upgradeTariffBtn.addEventListener('click', function() {
                showSubscriptionSheet();
                hideLimitWarning();
            });
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && limitSheetOverlay && limitSheetOverlay.style.display === 'flex') {
                hideLimitWarning();
            }
        });


        // Инициализация чата для логиста
        const orderChatModal = document.getElementById('orderChatModal');
        if (orderChatModal) {
            const overlay = orderChatModal.querySelector('.vacancies-modal__overlay');
            const closeBtn = orderChatModal.querySelector('.vacancies-modal__close');
            
            if (overlay) overlay.addEventListener('click', (e) => {
                if (e.target.dataset.close || e.target.classList.contains("vacancies-modal__overlay")) {
                    closeOrderChatLogist();
                }
            });
            
            if (closeBtn) closeBtn.addEventListener('click', closeOrderChatLogist);
            
            // Делегирование для закрытия по data-close
            orderChatModal.addEventListener('click', (e) => {
                if (e.target.dataset.close) {
                    closeOrderChatLogist();
                }
            });
            
            const chatSendBtn = document.getElementById('orderChatSendBtnLogist');
            const chatInput = document.getElementById('orderChatInputLogist');
            
            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', () => {
                    if (currentChatOrderId) {
                        sendOrderMessageLogist(currentChatOrderId);
                    }
                });
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (currentChatOrderId) {
                            sendOrderMessageLogist(currentChatOrderId);
                        }
                    }
                });
            }
        }

        // Делаем функции глобальными
        window.showPaymentSheet = showPaymentSheet;
        window.showLimitWarning = showLimitWarning;
        window.showSubscriptionSheet = showSubscriptionSheet;
        window.selectSubscription = selectSubscription;
        window.confirmSubscription = confirmSubscription;
        window.copyToClipboard = copyToClipboard;
        window.remindLater = remindLater;
        window.confirmPayment = confirmPayment;
    </script>
    
    <!-- Модальное окно чата заказа -->
    <div class="vacancies-modal" id="orderChatModal">
        <div class="vacancies-modal__overlay" data-close="true"></div>
        <div class="vacancies-modal__content">
            <div class="modal-content-wrapper">
                <!-- Ручка для свайпа -->
                <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px; margin: 12px auto 0;"></div>
                
                <!-- Header -->
                <div style="position: relative; margin-top: 16px; margin-bottom: 20px;">
                    <div class="vacancies-modal__close" data-close="true" style="position: absolute; top: 0; right: 0; font-size: 24px; cursor: pointer; color: #666;">&times;</div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 600; text-align: center; color: #333; font-family: 'Montserrat', sans-serif;">Чат заказа</h2>
                    <p id="orderChatSubtitle" style="margin: 8px 0 0; font-size: 14px; color: #666; text-align: center; font-family: 'Montserrat', sans-serif;"></p>
                </div>
                
                <!-- Сообщения чата -->
                <div id="orderChatMessagesLogist" style="max-height: calc(100vh - 300px); overflow-y: auto; margin-bottom: 16px; padding: 0 4px;">
                    <!-- Сообщения будут загружены здесь -->
                </div>
                
                <!-- Поле ввода -->
                <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid #E0E0E0;">
                    <input type="text" id="orderChatInputLogist" placeholder="Введите сообщение..." style="flex: 1; padding: 12px; border: 1px solid #E0E0E0; border-radius: 12px; font-size: 14px; font-family: 'Montserrat', sans-serif; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <button id="orderChatSendBtnLogist" style="width: 48px; height: 48px; padding: 0; background: #1775F1; color: white; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>